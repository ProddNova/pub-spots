<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mappa Luoghi Abbandonati Italia</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #333333;
      --popup-bg: #ffffff;
      --btn-bg: #f0f0f0;
      --btn-hover: #e0e0e0;
      --accent-color: #2c3e50;
    }

    /* Variabili Dark Mode */
    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --popup-bg: #2d2d2d;
      --btn-bg: #404040;
      --btn-hover: #505050;
      --accent-color: #4ca1af;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #map { height: 100%; width: 100%; transition: background 0.3s, color 0.3s; }
    
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    /* --- UI Controls --- */
    .control-container {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }

    .theme-toggle-btn {
      background: var(--popup-bg);
      color: var(--text-color);
      border: 2px solid rgba(0,0,0,0.2);
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .theme-toggle-btn:hover { transform: translateY(-1px); }

    /* --- Popup Styles --- */
    .leaflet-popup-content-wrapper {
      background: var(--popup-bg);
      color: var(--text-color);
      border-radius: 8px;
    }
    .leaflet-popup-tip { background: var(--popup-bg); }
    
    .leaflet-popup-content {
      max-height: 500px;
      overflow-y: auto;
      min-width: 280px;
      max-width: 320px;
      padding: 5px;
      margin: 10px;
    }

    .popup-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; color: var(--text-color); }
    .popup-desc { font-size: 13px; margin-bottom: 12px; line-height: 1.4; opacity: 0.9; }
    
    .location-info {
      font-size: 11px;
      margin-top: 8px;
      padding: 8px;
      background: var(--btn-bg);
      border-radius: 4px;
      border-left: 3px solid var(--accent-color);
    }

    /* Buttons inside Popup */
    .action-btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-top: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: opacity 0.2s;
    }
    .action-btn:hover { opacity: 0.9; }
    
    .btn-maps { background: #4285F4; color: white; }
    .btn-copy { background: #34A853; color: white; }

    /* --- Legend & Stats --- */
    .info-legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      background: var(--popup-bg);
      color: var(--text-color);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      font-size: 13px;
      border: 1px solid rgba(128,128,128,0.2);
    }

    /* --- Loading Spinner --- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 9999;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; color: white;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- Custom Pin Icon CSS --- */
    .custom-pin {
      filter: drop-shadow(0px 3px 2px rgba(0,0,0,0.5));
    }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div>Caricamento Luoghi...</div>
  </div>

  <div class="control-container">
    <button class="theme-toggle-btn" onclick="toggleDarkMode()">
      <span id="theme-icon">üåô</span> Dark Mode
    </button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // Configurazione Mappe
    const TILE_LIGHT = "https://tile.openstreetmap.org/{z}/{x}/{y}.png";
    const TILE_DARK = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
    const ATTRIBUTION = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

    // Bounding Box Approssimativo Italia (Lat Min/Max, Lon Min/Max)
    // Esclude grossolanamente punti non italiani
    const ITALY_BOUNDS = {
      minLat: 35.0, maxLat: 47.6,
      minLon: 6.0,  maxLon: 19.0
    };

    let map;
    let tileLayer;
    let markersClusterGroup;
    let locations = [];
    let isDarkMode = false;

    // ---------- Custom Black Icon ----------
    // Creiamo un SVG data URI per un pin nero con icona casa
    const customIconSvg = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="30" height="40">
        <path fill="#212121" d="M384 192c0 87.4-117 243-168.3 307.2c-12.3 15.3-35.1 15.3-47.4 0C117 435 0 279.4 0 192C0 86 86 0 192 0s192 86 192 192z"/>
        <path fill="#ffffff" transform="translate(96, 80) scale(0.5)" d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"/>
      </svg>
    `;

    const blackIcon = L.divIcon({
      className: 'custom-pin',
      html: customIconSvg,
      iconSize: [30, 42],
      iconAnchor: [15, 42],
      popupAnchor: [0, -40]
    });

    // ---------- Utils: HTML & CSV ----------
    function decodeHtmlEntities(str) {
      if (!str) return "";
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }

    // Parser CSV migliorato
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i++; } 
            else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"') { inQuotes = true; } 
          else if (c === ',') { row.push(field); field = ""; } 
          else if (c === '\n') { row.push(field); field = ""; rows.push(row); row = []; } 
          else if (c !== '\r') { field += c; }
        }
      }
      row.push(field);
      rows.push(row);
      return rows.filter(r => r.length > 1 || (r[0] && r[0].trim() !== ""));
    }

    function csvToObjects(csvText) {
      const rows = parseCSV(csvText);
      if (rows.length < 2) return [];
      const headers = rows[0].map(h => (h ?? "").trim());
      return rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = row[i] ?? "");
        return obj;
      });
    }

    function extractCoordinates(text) {
      if (!text) return null;
      // Decimali (priorit√†)
      const decMatch = text.match(/([+-]?\d+\.\d+)\s*[,;]\s*([+-]?\d+\.\d+)/);
      if (decMatch) {
        let lat = parseFloat(decMatch[1]);
        let lon = parseFloat(decMatch[2]);
        if (isValidCoord(lat, lon)) return { lat, lon };
      }
      // DMS
      const dmsPattern = /([0-9.]+)\s*¬∞\s*([0-9.]+)\s*['‚Ä≤]?\s*([0-9.]+(?:\.[0-9]+)?)?.*([NS]).*([0-9.]+)\s*¬∞\s*([0-9.]+)\s*['‚Ä≤]?\s*([0-9.]+(?:\.[0-9]+)?)?.*([EW])/i;
      const match = text.match(dmsPattern);
      if (match) {
        let lat = parseFloat(match[1]) + parseFloat(match[2])/60 + (parseFloat(match[3]||0))/3600;
        if (match[4].toUpperCase() === 'S') lat = -lat;
        let lon = parseFloat(match[5]) + parseFloat(match[6])/60 + (parseFloat(match[7]||0))/3600;
        if (match[8].toUpperCase() === 'W') lon = -lon;
        if (isValidCoord(lat, lon)) return { lat, lon };
      }
      return null;
    }

    function isValidCoord(lat, lon) {
      return lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
    }

    // ---------- Filtro Italia ----------
    function isInItaly(lat, lon) {
      return (lat >= ITALY_BOUNDS.minLat && lat <= ITALY_BOUNDS.maxLat &&
              lon >= ITALY_BOUNDS.minLon && lon <= ITALY_BOUNDS.maxLon);
    }

    // ---------- Core Logic ----------
    async function loadAndProcessData() {
      try {
        const response = await fetch('spot.csv');
        if (!response.ok) throw new Error("File spot.csv non trovato");

        const csvText = await response.text();
        const data = csvToObjects(csvText);
        
        let skippedItaly = 0;
        let skippedFormat = 0;

        for (const pin of data) {
          let coordText = (pin["grid_description"] || pin["description"] || pin["title"] || "").trim();
          coordText = decodeHtmlEntities(coordText).replace(/\s+/g, ' ').trim();
          
          const coords = extractCoordinates(coordText);
          
          if (!coords) {
            skippedFormat++;
            continue;
          }

          // ** Filtro Automatico Italia **
          if (!isInItaly(coords.lat, coords.lon)) {
            skippedItaly++;
            continue;
          }

          let imageUrl = (pin["story_pin_data/pages/0/blocks/0/image/images/originals/url"] || 
                          pin["image/url"] || pin["board/image_thumbnail_url"] || "").trim();

          locations.push({
            lat: coords.lat,
            lon: coords.lon,
            title: (pin["title"] || "Senza Titolo").trim(),
            desc: decodeHtmlEntities(pin["description"] || coordText || "").trim(),
            image: imageUrl
          });
        }

        console.log(`Caricati: ${locations.length}. Fuori Italia: ${skippedItaly}. Errati: ${skippedFormat}`);
        
        if (locations.length === 0) alert("Nessun luogo trovato in Italia.");
        
        initMap();

      } catch (error) {
        alert("Errore: " + error.message);
      } finally {
        document.getElementById('loading-overlay').style.display = 'none';
      }
    }

    function initMap() {
      // Centro sull'Italia di default
      map = L.map('map').setView([42.5, 12.5], 6);

      // Layer Base (inizia con Light)
      tileLayer = L.tileLayer(TILE_LIGHT, { attribution: ATTRIBUTION }).addTo(map);

      // Marker Cluster Group (migliora UX)
      markersClusterGroup = L.markerClusterGroup({
        showCoverageOnHover: false,
        maxClusterRadius: 50
      });

      locations.forEach(loc => {
        const marker = L.marker([loc.lat, loc.lon], { icon: blackIcon });
        
        const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lon}`;
        const coordString = `${loc.lat.toFixed(6)}, ${loc.lon.toFixed(6)}`;

        const popupHtml = `
          <div>
            ${loc.image ? `<img src="${loc.image}" style="width:100%; height:180px; object-fit:cover; border-radius:6px; margin-bottom:8px;" onerror="this.style.display='none'">` : ''}
            <div class="popup-title">${escapeHtml(loc.title)}</div>
            <div class="popup-desc">${escapeHtml(loc.desc.substring(0, 150))}${loc.desc.length > 150 ? '...' : ''}</div>
            
            <div class="location-info">üìç ${coordString}</div>
            
            <button class="action-btn btn-copy" onclick="copyCoords('${coordString}')">
              üìã Copia Coordinate
            </button>
            <button class="action-btn btn-maps" onclick="window.open('${gmapsUrl}', '_blank')">
              üó∫Ô∏è Apri Maps
            </button>
          </div>
        `;

        marker.bindPopup(popupHtml);
        markersClusterGroup.addLayer(marker);
      });

      map.addLayer(markersClusterGroup);

      // Statistiche Legend
      const legend = document.createElement('div');
      legend.className = 'info-legend';
      legend.innerHTML = `<strong>${locations.length}</strong> Luoghi in Italia`;
      document.body.appendChild(legend);

      // Fit bounds se ci sono punti
      if (locations.length > 0) {
        map.fitBounds(markersClusterGroup.getBounds(), { padding: [50, 50] });
      }
    }

    // ---------- Funzioni Interfaccia ----------

    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      const body = document.body;
      const btnIcon = document.getElementById('theme-icon');
      
      if (isDarkMode) {
        body.setAttribute('data-theme', 'dark');
        tileLayer.setUrl(TILE_DARK);
        btnIcon.textContent = '‚òÄÔ∏è';
      } else {
        body.removeAttribute('data-theme');
        tileLayer.setUrl(TILE_LIGHT);
        btnIcon.textContent = 'üåô';
      }
    }

    function copyCoords(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Coordinate copiate!');
      }).catch(err => {
        prompt("Copia manuale (CTRL+C):", text);
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Start
    loadAndProcessData();
  </script>
</body>
</html>
