<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mappa Luoghi Abbandonati</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    html, body, #map { 
      height: 100%; 
      width: 100%; 
    }
    
    /* Variabili tema rosso/nero */
    :root {
      --primary-red: #d32f2f;
      --primary-red-dark: #b71c1c;
      --primary-black: #121212;
      --secondary-black: #1e1e1e;
      --accent-red: #ff5252;
      --text-light: #ffffff;
      --text-gray: #b0b0b0;
      --card-bg: #1a1a1a;
      --border-color: #333333;
      --shadow-dark: rgba(0, 0, 0, 0.5);
    }
    
    body {
      background: var(--primary-black);
      color: var(--text-light);
      overflow: hidden;
    }
    
    /* Header branding */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      border-bottom: 2px solid var(--primary-red);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px var(--shadow-dark);
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: bold;
    }
    
    .brand-text h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
      line-height: 1.2;
    }
    
    .brand-text p {
      font-size: 12px;
      color: var(--text-gray);
    }
    
    /* Stats panel ridisegnato */
    .stats-panel {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .stat-item {
      text-align: center;
      min-width: 60px;
    }
    
    .stat-number {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-red);
      line-height: 1;
    }
    
    .stat-label {
      font-size: 10px;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }
    
    /* Pulsanti azione */
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      background: var(--secondary-black);
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .action-btn:hover {
      background: var(--primary-red);
      border-color: var(--primary-red);
      transform: translateY(-2px);
    }
    
    /* Popup personalizzato */
    .leaflet-popup-content-wrapper {
      background: var(--card-bg);
      color: var(--text-light);
      border-radius: 12px;
      border: 2px solid var(--primary-red);
      box-shadow: 0 10px 30px var(--shadow-dark);
      padding: 0;
      overflow: hidden;
    }
    
    .leaflet-popup-content {
      margin: 0;
      padding: 0;
      max-width: 300px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .leaflet-popup-tip {
      background: var(--primary-red);
    }
    
    .popup-header {
      padding: 15px;
      background: linear-gradient(135deg, var(--primary-red), var(--primary-red-dark));
      color: white;
    }
    
    .popup-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .popup-coords {
      font-size: 11px;
      opacity: 0.9;
      font-family: monospace;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .popup-body {
      padding: 15px;
    }
    
    .popup-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
    }
    
    .popup-description {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-gray);
      margin-bottom: 15px;
    }
    
    .popup-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .popup-btn {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.2s;
    }
    
    .popup-btn.copy {
      background: var(--secondary-black);
      color: var(--text-light);
      border: 1px solid var(--border-color);
    }
    
    .popup-btn.copy:hover {
      background: var(--primary-red);
      border-color: var(--primary-red);
    }
    
    .popup-btn.maps {
      background: var(--primary-red);
      color: white;
    }
    
    .popup-btn.maps:hover {
      background: var(--primary-red-dark);
      transform: translateY(-2px);
    }
    
    /* Loader fullscreen */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary-black);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s;
    }
    
    .loader-logo {
      width: 80px;
      height: 80px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      animation: pulse 2s infinite;
    }
    
    .loader-logo i {
      font-size: 36px;
      color: white;
    }
    
    .loader-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 10px;
      text-align: center;
    }
    
    .loader-subtext {
      color: var(--text-gray);
      text-align: center;
      max-width: 300px;
      line-height: 1.5;
    }
    
    .loader-progress {
      width: 300px;
      height: 4px;
      background: var(--secondary-black);
      border-radius: 2px;
      margin-top: 30px;
      overflow: hidden;
    }
    
    .loader-progress-bar {
      height: 100%;
      background: var(--primary-red);
      width: 0%;
      transition: width 0.3s;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Footer mobile */
    .mobile-footer {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-top: 2px solid var(--primary-red);
      z-index: 1000;
    }
    
    .mobile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      text-align: center;
    }
    
    /* Mobile optimization */
    @media (max-width: 768px) {
      .header {
        padding: 12px 15px;
      }
      
      .brand-text h1 {
        font-size: 16px;
      }
      
      .brand-text p {
        display: none;
      }
      
      .action-buttons {
        display: none;
      }
      
      .stats-panel {
        gap: 15px;
      }
      
      .stat-item {
        min-width: 50px;
      }
      
      .stat-number {
        font-size: 18px;
      }
      
      .mobile-footer {
        display: block;
      }
      
      .leaflet-popup-content {
        max-width: 250px;
      }
      
      .loader-text {
        font-size: 20px;
      }
      
      .loader-progress {
        width: 250px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 10px;
      }
      
      .stat-item {
        min-width: 40px;
      }
      
      .stat-number {
        font-size: 16px;
      }
      
      .stat-label {
        font-size: 9px;
      }
    }
    
    /* Stile mappa dark */
    .leaflet-container {
      background: var(--primary-black);
    }
    
    /* Icona pin personalizzata rosso/nero */
    .red-black-icon {
      filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.7));
    }
    
    /* Pulsanti mappa custom */
    .leaflet-control-zoom a {
      background: var(--secondary-black) !important;
      color: var(--text-light) !important;
      border: 1px solid var(--border-color) !important;
    }
    
    .leaflet-control-zoom a:hover {
      background: var(--primary-red) !important;
      border-color: var(--primary-red) !important;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="logo">
        <i class="fas fa-skull-crossbones"></i>
      </div>
      <div class="brand-text">
        <h1>Esplora Luoghi Abbandonati</h1>
        <p>Scopri posti dimenticati in tutta Italia</p>
      </div>
    </div>
    
    <div class="stats-panel">
      <div class="stat-item">
        <span class="stat-number" id="loadedCount">0</span>
        <span class="stat-label">Luoghi</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="filteredCount">0</span>
        <span class="stat-label">In Italia</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="progressPercent">0%</span>
        <span class="stat-label">Caricati</span>
      </div>
    </div>
    
    <div class="action-buttons">
      <button class="action-btn" onclick="zoomToItaly()">
        <i class="fas fa-italy"></i>
        <span>Vista Italia</span>
      </button>
      <button class="action-btn" onclick="showAllMarkers()">
        <i class="fas fa-eye"></i>
        <span>Mostra Tutti</span>
      </button>
    </div>
  </div>
  
  <!-- Mappa -->
  <div id="map"></div>
  
  <!-- Footer Mobile -->
  <div class="mobile-footer">
    <div class="mobile-stats">
      <div>
        <div class="stat-number" id="mobileLoadedCount">0</div>
        <div class="stat-label">Luoghi</div>
      </div>
      <div>
        <div class="stat-number" id="mobileFilteredCount">0</div>
        <div class="stat-label">In Italia</div>
      </div>
      <div>
        <div class="stat-number" id="mobileProgress">0%</div>
        <div class="stat-label">Caricati</div>
      </div>
    </div>
  </div>
  
  <!-- Loader -->
  <div class="loader-overlay" id="loader">
    <div class="loader-logo">
      <i class="fas fa-map-marked-alt"></i>
    </div>
    <div class="loader-text">Caricamento Mappa</div>
    <div class="loader-subtext">
      Sto cercando i luoghi abbandonati più interessanti per te...
    </div>
    <div class="loader-progress">
      <div class="loader-progress-bar" id="progressBar"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Configurazioni
    const MAP_TILE_SERVER_DARK = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png";
    const ITALY_CENTER = [42.5, 12.5];
    const DEFAULT_ZOOM = 6;
    
    // Bounding box Italia
    const ITALY_BOUNDS = {
      minLat: 36.0,
      maxLat: 47.5,
      minLon: 6.0,
      maxLon: 19.0
    };
    
    let locations = [];
    let map;
    let markers = [];
    let totalProcessed = 0;
    let totalLocations = 0;
    
    // ---------- Icona personalizzata rosso/nero ----------
    const RedBlackIcon = L.divIcon({
      className: 'red-black-icon',
      html: `
        <div style="
          width: 30px;
          height: 30px;
          background: #d32f2f;
          border: 3px solid #121212;
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          position: relative;
          box-shadow: 0 0 10px rgba(0,0,0,0.5);
        ">
          <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            color: white;
            font-size: 14px;
            font-weight: bold;
          ">
            <i class="fas fa-map-pin"></i>
          </div>
        </div>
      `,
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -30]
    });
    
    // ---------- Aggiorna progresso ----------
    function updateProgress(current, total, step) {
      const percent = Math.min(Math.round((current / total) * 100), 100);
      document.getElementById('progressPercent').textContent = `${percent}%`;
      document.getElementById('mobileProgress').textContent = `${percent}%`;
      document.getElementById('progressBar').style.width = `${percent}%`;
      
      // Aggiorna testo loader
      const steps = [
        "Analizzo i dati...",
        "Trovo le coordinate...",
        "Filtro per l'Italia...",
        "Preparo la mappa...",
        "Quasi pronto..."
      ];
      
      if (step < steps.length) {
        document.querySelector('.loader-subtext').textContent = steps[step];
      }
    }
    
    // ---------- Controlla se in Italia ----------
    function isInItaly(lat, lon) {
      return lat >= ITALY_BOUNDS.minLat && 
             lat <= ITALY_BOUNDS.maxLat && 
             lon >= ITALY_BOUNDS.minLon && 
             lon <= ITALY_BOUNDS.maxLon;
    }
    
    // ---------- Decodifica HTML ----------
    function decodeHtmlEntities(str) {
      if (!str) return "";
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }
    
    // ---------- CSV Parsing ----------
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;
      
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ',') {
            row.push(field);
            field = "";
          } else if (c === '\r') {
            // ignora
          } else if (c === '\n') {
            row.push(field);
            field = "";
            rows.push(row);
            row = [];
          } else {
            field += c;
          }
        }
      }
      
      // ultimo campo
      row.push(field);
      rows.push(row);
      
      // rimuove righe vuote
      while (rows.length && rows[rows.length - 1].every(v => (v ?? "").trim() === "")) {
        rows.pop();
      }
      
      return rows;
    }
    
    function csvToObjects(csvText) {
      const rows = parseCSV(csvText);
      if (!rows.length) return [];
      
      const headers = rows[0].map(h => (h ?? "").trim());
      const objs = [];
      
      for (let r = 1; r < rows.length; r++) {
        const line = rows[r];
        if (!line || line.every(v => (v ?? "").trim() === "")) continue;
        
        const obj = {};
        for (let c = 0; c < headers.length; c++) {
          const key = headers[c];
          if (!key) continue;
          obj[key] = line[c] ?? "";
        }
        objs.push(obj);
      }
      return objs;
    }
    
    // ---------- Estrazione coordinate ----------
    function extractCoordinates(text) {
      if (!text) return null;
      
      // DMS tipo: 43°52'23.7"N 20°21'38.8"E
      const dmsPattern =
        /([0-9.]+)\s*°\s*([0-9.]+)\s*['′]?\s*([0-9.]+(?:\.[0-9]+)?)?\s*["″]?\s*([NSns])\s+([0-9.]+)\s*°\s*([0-9.]+)\s*['′]?\s*([0-9.]+(?:\.[0-9]+)?)?\s*["″]?\s*([EWew])/i;
      
      const match = text.match(dmsPattern);
      
      if (match) {
        let latDeg = parseFloat(match[1]);
        let latMin = parseFloat(match[2]);
        let latSec = parseFloat(match[3] || '0');
        let latDir = match[4].toUpperCase();
        
        let lonDeg = parseFloat(match[5]);
        let lonMin = parseFloat(match[6]);
        let lonSec = parseFloat(match[7] || '0');
        let lonDir = match[8].toUpperCase();
        
        let lat = latDeg + latMin / 60 + latSec / 3600;
        let lon = lonDeg + lonMin / 60 + lonSec / 3600;
        
        if (latDir === 'S') lat = -lat;
        if (lonDir === 'W') lon = -lon;
        
        if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
          return { lat: parseFloat(lat.toFixed(8)), lon: parseFloat(lon.toFixed(8)) };
        }
      }
      
      // Decimali tipo: 45.12345, 9.12345
      const decimalPattern = /([+-]?\d+\.\d+)\s*[,;]?\s*([+-]?\d+\.\d+)/;
      const decMatch = text.match(decimalPattern);
      if (decMatch) {
        let lat = parseFloat(decMatch[1]);
        let lon = parseFloat(decMatch[2]);
        if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
          return { lat, lon };
        }
      }
      
      return null;
    }
    
    // ---------- Carica e processa dati ----------
    async function loadAndProcessData() {
      try {
        updateProgress(0, 100, 0);
        
        // Simula un piccolo ritardo per mostrare il loader
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const response = await fetch('spot.csv');
        if (!response.ok) throw new Error(`Impossibile caricare i dati (HTTP ${response.status})`);
        
        const csvText = await response.text();
        const data = csvToObjects(csvText);
        
        if (!Array.isArray(data)) {
          throw new Error("Formato dati non riconosciuto");
        }
        
        totalLocations = data.length;
        let validInItaly = 0;
        let currentStep = 0;
        
        updateProgress(0, totalLocations, 1);
        
        // Processa in batch per non bloccare l'UI
        const batchSize = 50;
        for (let i = 0; i < data.length; i += batchSize) {
          const batch = data.slice(i, i + batchSize);
          
          for (const pin of batch) {
            totalProcessed++;
            
            // Aggiorna progresso ogni 10 elementi
            if (totalProcessed % 10 === 0 || totalProcessed === totalLocations) {
              updateProgress(totalProcessed, totalLocations, currentStep);
              currentStep = Math.min(Math.floor(totalProcessed / (totalLocations / 4)), 4);
              
              // Piccola pausa per non sovraccaricare l'UI
              await new Promise(resolve => setTimeout(resolve, 1));
            }
            
            // Estrai coordinate
            let coordText =
              (pin["grid_description"] || pin["description"] || pin["title"] || pin["grid_title"] || "").trim();
            
            if (!coordText) continue;
            
            coordText = decodeHtmlEntities(coordText).replace(/\s+/g, ' ').trim();
            const coordMatch = extractCoordinates(coordText);
            
            if (!coordMatch) continue;
            
            // Filtra per Italia
            if (!isInItaly(coordMatch.lat, coordMatch.lon)) continue;
            
            validInItaly++;
            
            const title = (pin["title"] || pin["grid_title"] || "Luogo Sconosciuto").trim();
            const descriptionRaw = (pin["grid_description"] || pin["description"] || "").trim();
            const description = decodeHtmlEntities(descriptionRaw).replace(/\s+/g, ' ').trim();
            
            // Immagine
            let imageUrl =
              (pin["story_pin_data/pages/0/blocks/0/image/images/originals/url"] || "").trim();
            
            if (!imageUrl) {
              imageUrl = (pin["image/url"] || "").trim();
            }
            
            locations.push({
              latitude: coordMatch.lat,
              longitude: coordMatch.lon,
              title: title.substring(0, 100),
              description: description.substring(0, 200),
              image: imageUrl || null
            });
          }
        }
        
        // Aggiorna statistiche
        document.getElementById('loadedCount').textContent = locations.length;
        document.getElementById('mobileLoadedCount').textContent = locations.length;
        document.getElementById('filteredCount').textContent = validInItaly;
        document.getElementById('mobileFilteredCount').textContent = validInItaly;
        
        if (locations.length === 0) {
          document.querySelector('.loader-text').textContent = "Nessun luogo trovato";
          document.querySelector('.loader-subtext').textContent = "Non ho trovato luoghi abbandonati in Italia nel tuo file dati";
          setTimeout(() => {
            initMap();
            hideLoader();
          }, 2000);
          return;
        }
        
        // Inizializza mappa
        initMap();
        
        // Piccolo ritardo per mostrare il 100%
        setTimeout(hideLoader, 500);
        
      } catch (error) {
        console.error("Errore:", error);
        document.querySelector('.loader-text').textContent = "Errore nel caricamento";
        document.querySelector('.loader-subtext').textContent = error.message;
        document.getElementById('progressBar').style.background = "#ff4444";
        
        setTimeout(() => {
          alert("Errore: " + error.message);
          initMap();
          hideLoader();
        }, 3000);
      }
    }
    
    // ---------- Nascondi loader ----------
    function hideLoader() {
      const loader = document.getElementById('loader');
      loader.style.opacity = '0';
      setTimeout(() => {
        loader.style.display = 'none';
      }, 500);
    }
    
    // ---------- Inizializza mappa ----------
    function initMap() {
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      }).setView(ITALY_CENTER, DEFAULT_ZOOM);
      
      // Tile dark
      L.tileLayer(MAP_TILE_SERVER_DARK, {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      
      // Aggiungi marker
      addMarkersToMap();
      
      // Aggiungi controlli
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);
    }
    
    // ---------- Aggiungi marker alla mappa ----------
    function addMarkersToMap() {
      markers = [];
      
      locations.forEach((loc, index) => {
        // Piccolo ritardo per animazione
        setTimeout(() => {
          const marker = L.marker([loc.latitude, loc.longitude], {
            icon: RedBlackIcon
          }).addTo(map);
          
          markers.push(marker);
          
          // Popup content
          const popupContent = `
            <div class="popup-header">
              <div class="popup-title">${escapeHtml(loc.title)}</div>
              <div class="popup-coords">
                <i class="fas fa-map-marker-alt"></i>
                ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}
              </div>
            </div>
            <div class="popup-body">
              ${loc.image ? `
                <img src="${loc.image}" class="popup-image" 
                     alt="${escapeHtml(loc.title)}"
                     onerror="this.style.display='none'">
              ` : ''}
              <div class="popup-description">
                ${escapeHtml(loc.description || 'Nessuna descrizione disponibile')}
              </div>
              <div class="popup-actions">
                <button class="popup-btn copy" onclick="copyCoords(${loc.latitude}, ${loc.longitude}, this)">
                  <i class="far fa-copy"></i> Copia
                </button>
                <button class="popup-btn maps" onclick="openMaps(${loc.latitude}, ${loc.longitude})">
                  <i class="fab fa-google"></i> Google Maps
                </button>
              </div>
            </div>
          `;
          
          marker.bindPopup(popupContent);
          
          // Solo click apre il popup (rimosso hover)
          marker.on('click', function() {
            this.openPopup();
          });
          
        }, index * 20); // Piccolo delay per effetto a cascata
      });
      
      // Centra la mappa sui marker
      if (locations.length > 0) {
        setTimeout(() => {
          if (locations.length === 1) {
            map.setView([locations[0].latitude, locations[0].longitude], 13);
          } else {
            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        }, locations.length * 20 + 100);
      }
    }
    
    // ---------- Funzioni utility ----------
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function copyCoords(lat, lon, button) {
      const coords = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      navigator.clipboard.writeText(coords).then(() => {
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiato!';
        button.style.background = '#4CAF50';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      }).catch(() => {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = coords;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiato!';
        button.style.background = '#4CAF50';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      });
    }
    
    function openMaps(lat, lon) {
      const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      window.open(url, '_blank');
    }
    
    function zoomToItaly() {
      map.setView(ITALY_CENTER, DEFAULT_ZOOM);
    }
    
    function showAllMarkers() {
      if (markers.length > 0) {
        const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
        map.fitBounds(bounds, { padding: [100, 100] });
      }
    }
    
    // ---------- Inizializza app ----------
    document.addEventListener('DOMContentLoaded', function() {
      // Avvia caricamento dati
      loadAndProcessData();
      
      // Aggiungi listener per resize
      window.addEventListener('resize', function() {
        if (map) {
          map.invalidateSize();
        }
      });
    });
  </script>
</body>
</html>
