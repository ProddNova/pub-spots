<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Urbex Map LT-Unit</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    html, body, #map { 
      height: 100%; 
      width: 100%; 
      overflow: hidden;
    }
    
    /* Variabili tema rosso/nero */
    :root {
      --primary-red: #d32f2f;
      --primary-red-dark: #b71c1c;
      --primary-black: #121212;
      --secondary-black: #1e1e1e;
      --accent-red: #ff5252;
      --text-light: #ffffff;
      --text-gray: #b0b0b0;
      --card-bg: #1a1a1a;
      --border-color: #333333;
      --shadow-dark: rgba(0, 0, 0, 0.5);
    }
    
    body {
      background: var(--primary-black);
      color: var(--text-light);
    }
    
    /* Header branding */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      border-bottom: 2px solid var(--primary-red);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px var(--shadow-dark);
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo {
      width: 36px;
      height: 36px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      font-weight: bold;
    }
    
    .brand-text h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-light);
      line-height: 1.2;
    }
    
    .brand-text p {
      font-size: 11px;
      color: var(--text-gray);
    }
    
    /* Stats panel ottimizzato */
    .stats-panel {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .stat-item {
      text-align: center;
      min-width: 55px;
    }
    
    .stat-number {
      display: block;
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-red);
      line-height: 1;
    }
    
    .stat-label {
      font-size: 9px;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }
    
    /* Social unlock modal */
    .social-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary-black);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .social-modal.hidden {
      display: none;
    }
    
    .social-logo {
      width: 80px;
      height: 80px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }
    
    .social-logo i {
      font-size: 36px;
      color: white;
    }
    
    .social-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 10px;
      text-align: center;
    }
    
    .social-subtitle {
      color: var(--text-gray);
      text-align: center;
      max-width: 500px;
      line-height: 1.5;
      font-size: 16px;
      margin-bottom: 30px;
    }
    
    .social-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 30px;
    }
    
    .social-btn {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      background: var(--secondary-black);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .social-btn:hover {
      background: var(--primary-black);
      border-color: var(--primary-red);
      transform: translateY(-2px);
    }
    
    .social-btn i {
      font-size: 24px;
      width: 30px;
      text-align: center;
    }
    
    .social-btn.youtube i {
      color: #FF0000;
    }
    
    .social-btn.instagram i {
      color: #E4405F;
    }
    
    .social-btn.tiktok i {
      color: #000000;
    }
    
    .countdown {
      font-size: 14px;
      color: var(--text-gray);
      text-align: center;
      margin-top: 20px;
    }
    
    .countdown.hidden {
      display: none;
    }
    
    .countdown-timer {
      font-weight: bold;
      color: var(--primary-red);
    }
    
    /* Popup ottimizzato */
    .leaflet-popup-content-wrapper {
      background: var(--card-bg);
      color: var(--text-light);
      border-radius: 10px;
      border: 2px solid var(--primary-red);
      box-shadow: 0 8px 25px var(--shadow-dark);
      padding: 0;
      overflow: hidden;
      max-width: 300px;
    }
    
    .leaflet-popup-content {
      margin: 0;
      padding: 0;
      max-height: 350px;
      overflow-y: auto;
    }
    
    .leaflet-popup-tip {
      background: var(--primary-red);
    }
    
    .popup-header {
      padding: 12px;
      background: linear-gradient(135deg, var(--primary-red), var(--primary-red-dark));
      color: white;
    }
    
    .popup-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
      line-height: 1.2;
    }
    
    .popup-coords {
      font-size: 10px;
      opacity: 0.9;
      font-family: monospace;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .popup-body {
      padding: 12px;
    }
    
    .popup-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      background: #222;
    }
    
    .popup-description {
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-gray);
      margin-bottom: 12px;
    }
    
    .popup-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .popup-btn {
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.2s;
    }
    
    .popup-btn.copy {
      background: var(--secondary-black);
      color: var(--text-light);
      border: 1px solid var(--border-color);
    }
    
    .popup-btn.copy:hover {
      background: var(--primary-red);
      border-color: var(--primary-red);
    }
    
    .popup-btn.maps {
      background: var(--primary-red);
      color: white;
    }
    
    .popup-btn.maps:hover {
      background: var(--primary-red-dark);
    }
    
    /* Loader ottimizzato */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary-black);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .loader-overlay.hidden {
      display: none;
    }
    
    .loader-logo {
      width: 70px;
      height: 70px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 25px;
    }
    
    .loader-logo i {
      font-size: 32px;
      color: white;
    }
    
    .loader-text {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 8px;
      text-align: center;
    }
    
    .loader-subtext {
      color: var(--text-gray);
      text-align: center;
      max-width: 280px;
      line-height: 1.4;
      font-size: 14px;
    }
    
    .loader-progress {
      width: 280px;
      height: 4px;
      background: var(--secondary-black);
      border-radius: 2px;
      margin-top: 25px;
      overflow: hidden;
    }
    
    .loader-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-red), var(--accent-red));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-percent {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-red);
      margin-top: 8px;
    }
    
    /* Footer mobile */
    .mobile-footer {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 15px;
      border-top: 2px solid var(--primary-red);
      z-index: 1000;
    }
    
    .mobile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      text-align: center;
    }
    
    /* Mobile optimization */
    @media (max-width: 768px) {
      .header {
        padding: 8px 15px;
      }
      
      .brand-text h1 {
        font-size: 14px;
      }
      
      .brand-text p {
        display: none;
      }
      
      .stats-panel {
        gap: 12px;
      }
      
      .stat-item {
        min-width: 45px;
      }
      
      .stat-number {
        font-size: 16px;
      }
      
      .mobile-footer {
        display: block;
      }
      
      .social-title {
        font-size: 24px;
      }
      
      .social-subtitle {
        font-size: 14px;
        padding: 0 10px;
      }
      
      .social-buttons {
        padding: 0 10px;
      }
      
      .social-btn {
        padding: 12px 15px;
        font-size: 14px;
      }
      
      .leaflet-popup-content-wrapper {
        max-width: 260px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 8px 10px;
      }
      
      .stat-item {
        min-width: 40px;
      }
      
      .stat-number {
        font-size: 14px;
      }
      
      .stat-label {
        font-size: 8px;
      }
      
      .social-title {
        font-size: 20px;
      }
      
      .social-buttons {
        width: 90%;
      }
    }
    
    /* Animazioni */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Stile per mappa senza zoom control */
    .leaflet-control-zoom {
      display: none !important;
    }
    
    /* Evita scroll nei popup su mobile */
    .leaflet-popup-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .leaflet-popup-content::-webkit-scrollbar-track {
      background: var(--secondary-black);
    }
    
    .leaflet-popup-content::-webkit-scrollbar-thumb {
      background: var(--primary-red);
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <!-- Social Unlock Modal -->
  <div class="social-modal" id="socialModal">
    <div class="social-logo">
      <i class="fas fa-lock"></i>
    </div>
    <div class="social-title">Urbex Map LT-Unit</div>
    <div class="social-subtitle">
      Per sbloccare l'accesso alla mappa completa, seguici sui nostri social!
    </div>
    
    <div class="social-buttons">
      <a href="https://www.youtube.com/@LostTrace-Unit" target="_blank" class="social-btn youtube" id="youtubeBtn">
        <i class="fab fa-youtube"></i>
        <span>YouTube @LostTrace-Unit</span>
      </a>
      
      <a href="https://www.instagram.com/losttrace__/" target="_blank" class="social-btn instagram" id="instagramBtn">
        <i class="fab fa-instagram"></i>
        <span>Instagram @losttrace__</span>
      </a>
      
      <a href="https://www.tiktok.com/@lt_unit" target="_blank" class="social-btn tiktok" id="tiktokBtn">
        <i class="fab fa-tiktok"></i>
        <span>TikTok @lt_unit</span>
      </a>
    </div>
    
    <div class="countdown hidden" id="countdown">
      Accesso in sblocco... <span class="countdown-timer" id="countdownTimer">45</span> secondi
    </div>
  </div>
  
  <!-- Header -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="brand">
      <div class="logo">
        <i class="fas fa-skull-crossbones"></i>
      </div>
      <div class="brand-text">
        <h1>Urbex Map LT-Unit</h1>
        <p>Mappa luoghi abbandonati</p>
      </div>
    </div>
    
    <div class="stats-panel">
      <div class="stat-item">
        <span class="stat-number" id="loadedCount">0</span>
        <span class="stat-label">Luoghi</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="progressPercent">0%</span>
        <span class="stat-label">Caricati</span>
      </div>
    </div>
  </div>
  
  <!-- Mappa -->
  <div id="map" style="display: none;"></div>
  
  <!-- Footer Mobile -->
  <div class="mobile-footer" id="mobileFooter" style="display: none;">
    <div class="mobile-stats">
      <div>
        <div class="stat-number" id="mobileLoadedCount">0</div>
        <div class="stat-label">Luoghi</div>
      </div>
      <div>
        <div class="stat-number" id="mobileProgress">0%</div>
        <div class="stat-label">Caricati</div>
      </div>
    </div>
  </div>
  
  <!-- Loader -->
  <div class="loader-overlay hidden" id="loader">
    <div class="loader-logo">
      <i class="fas fa-map-marked-alt"></i>
    </div>
    <div class="loader-text">Caricamento Mappa</div>
    <div class="loader-subtext" id="loaderStatus">
      Inizializzazione sistema urbex...
    </div>
    <div class="loader-progress">
      <div class="loader-progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-percent" id="progressText">0%</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== CONFIGURAZIONI E VARIABILI GLOBALI =====
    const CONFIG = {
      MAP_TILE_DARK: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
      MAP_TILE_ATTR: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      ITALY_CENTER: [42.5, 12.5],
      DEFAULT_ZOOM: 6,
      
      // Bounding box Italia
      ITALY_BOUNDS: {
        minLat: 36.5,
        maxLat: 47.0,
        minLon: 6.5,
        maxLon: 18.5
      },
      
      // Social unlock
      UNLOCK_DELAY: 45, // 45 secondi di countdown
      
      // Performance settings
      BATCH_SIZE: 100
    };
    
    // Variabili globali
    let map = null;
    let markersLayer = null;
    let allMarkers = [];
    let filteredLocations = [];
    
    // Variabili social unlock
    let socialClicks = {
      youtube: false,
      instagram: false,
      tiktok: false
    };
    let unlockTimer = null;
    let unlockTimeRemaining = CONFIG.UNLOCK_DELAY;
    let unlockStarted = false;
    
    // Statistiche di caricamento
    const stats = {
      totalCSV: 0,
      totalItaly: 0,
      currentStep: 0,
      steps: [
        "Analizzo i dati...",
        "Trovo le coordinate...",
        "Filtro per l'Italia...",
        "Preparo la mappa...",
        "Caricamento completato!"
      ]
    };
    
    // ===== FUNZIONI SOCIAL UNLOCK =====
    
    function initializeSocialUnlock() {
      // Controlla se già sbloccato in precedenza
      const alreadyUnlocked = localStorage.getItem('urbexMapUnlocked') === 'true';
      
      if (alreadyUnlocked) {
        // Salta direttamente al caricamento
        document.getElementById('socialModal').classList.add('hidden');
        document.getElementById('mainHeader').style.display = 'flex';
        document.getElementById('map').style.display = 'block';
        document.getElementById('mobileFooter').style.display = 'block';
        startMapLoading();
      } else {
        // Mostra il modal di sblocco
        setupSocialButtons();
      }
    }
    
    function setupSocialButtons() {
      const youtubeBtn = document.getElementById('youtubeBtn');
      const instagramBtn = document.getElementById('instagramBtn');
      const tiktokBtn = document.getElementById('tiktokBtn');
      
      youtubeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        socialClicks.youtube = true;
        checkSocialClicks();
        window.open(this.href, '_blank');
      });
      
      instagramBtn.addEventListener('click', function(e) {
        e.preventDefault();
        socialClicks.instagram = true;
        checkSocialClicks();
        window.open(this.href, '_blank');
      });
      
      tiktokBtn.addEventListener('click', function(e) {
        e.preventDefault();
        socialClicks.tiktok = true;
        checkSocialClicks();
        window.open(this.href, '_blank');
      });
    }
    
    function checkSocialClicks() {
      if (!unlockStarted) {
        unlockStarted = true;
        startUnlockCountdown();
      }
      
      // Controlla se tutti i social sono stati cliccati
      const allClicked = socialClicks.youtube && socialClicks.instagram && socialClicks.tiktok;
      
      if (allClicked) {
        // Se cliccati tutti, sblocca immediatamente
        unlockMap();
      }
    }
    
    function startUnlockCountdown() {
      document.getElementById('countdown').classList.remove('hidden');
      
      unlockTimer = setInterval(() => {
        unlockTimeRemaining--;
        document.getElementById('countdownTimer').textContent = unlockTimeRemaining;
        
        if (unlockTimeRemaining <= 0) {
          clearInterval(unlockTimer);
          unlockMap();
        }
      }, 1000);
    }
    
    function unlockMap() {
      clearInterval(unlockTimer);
      
      // Salva lo sblocco in localStorage
      localStorage.setItem('urbexMapUnlocked', 'true');
      
      // Nascondi modal e mostra tutto il resto
      document.getElementById('socialModal').classList.add('hidden');
      document.getElementById('mainHeader').style.display = 'flex';
      document.getElementById('map').style.display = 'block';
      document.getElementById('mobileFooter').style.display = 'block';
      
      // Inizia il caricamento della mappa
      startMapLoading();
    }
    
    // ===== FUNZIONI DI UTILITY =====
    
    function updateProgress(current, total, stepIndex = null) {
      const percent = Math.min(Math.round((current / total) * 100), 100);
      
      // Aggiorna percentuali
      document.getElementById('progressPercent').textContent = `${percent}%`;
      document.getElementById('mobileProgress').textContent = `${percent}%`;
      document.getElementById('progressText').textContent = `${percent}%`;
      
      // Progress bar
      document.getElementById('progressBar').style.width = `${percent}%`;
      
      // Aggiorna testo loader
      if (stepIndex !== null && stepIndex < stats.steps.length) {
        document.getElementById('loaderStatus').textContent = stats.steps[stepIndex];
        stats.currentStep = stepIndex;
      }
      
      // Aggiorna contatori
      if (stats.totalItaly > 0) {
        document.getElementById('loadedCount').textContent = stats.totalItaly;
        document.getElementById('mobileLoadedCount').textContent = stats.totalItaly;
      }
      
      // Forza reflow per animazione fluida
      document.getElementById('progressBar').offsetHeight;
    }
    
    // Controlla se coordinate sono in Italia
    function isInItaly(lat, lon) {
      return lat >= CONFIG.ITALY_BOUNDS.minLat && 
             lat <= CONFIG.ITALY_BOUNDS.maxLat && 
             lon >= CONFIG.ITALY_BOUNDS.minLon && 
             lon <= CONFIG.ITALY_BOUNDS.maxLon;
    }
    
    // Decodifica HTML entities
    function decodeHtmlEntities(str) {
      if (!str) return "";
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }
    
    // Parsing CSV ottimizzato
    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let currentField = "";
      let inQuotes = false;
      
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        
        if (inQuotes) {
          if (char === '"' && text[i + 1] === '"') {
            currentField += '"';
            i++;
          } else if (char === '"') {
            inQuotes = false;
          } else {
            currentField += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            currentRow.push(currentField);
            currentField = "";
          } else if (char === '\r') {
            continue;
          } else if (char === '\n') {
            currentRow.push(currentField);
            rows.push(currentRow);
            currentRow = [];
            currentField = "";
          } else {
            currentField += char;
          }
        }
      }
      
      if (currentField || currentRow.length) {
        currentRow.push(currentField);
        rows.push(currentRow);
      }
      
      return rows.filter(row => row.some(field => field.trim()));
    }
    
    // Converti CSV in oggetti
    function csvToObjects(csvText) {
      try {
        const rows = parseCSV(csvText);
        if (rows.length < 2) return [];
        
        const headers = rows[0].map(h => h.trim());
        const result = [];
        
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const obj = {};
          
          for (let j = 0; j < headers.length; j++) {
            if (j < row.length) {
              obj[headers[j]] = row[j] || "";
            } else {
              obj[headers[j]] = "";
            }
          }
          
          result.push(obj);
        }
        
        return result;
      } catch (error) {
        console.error("Errore parsing CSV:", error);
        return [];
      }
    }
    
    // Estrazione coordinate ottimizzata
    function extractCoordinates(text) {
      if (!text) return null;
      
      // Cerca prima coordinate decimali (più comune)
      const decimalPattern = /([+-]?\d+\.\d+)\s*[,;]?\s*([+-]?\d+\.\d+)/;
      const decMatch = text.match(decimalPattern);
      
      if (decMatch) {
        const lat = parseFloat(decMatch[1]);
        const lon = parseFloat(decMatch[2]);
        
        if (!isNaN(lat) && !isNaN(lon) && 
            lat >= -90 && lat <= 90 && 
            lon >= -180 && lon <= 180) {
          return { lat, lon };
        }
      }
      
      // Fallback: cerca coordinate DMS
      const dmsPattern = /(\d+)[°º]\s*(\d+)[′']\s*([\d.]+)?[″"]?\s*([NS])\s+(\d+)[°º]\s*(\d+)[′']\s*([\d.]+)?[″"]?\s*([EW])/i;
      const dmsMatch = text.match(dmsPattern);
      
      if (dmsMatch) {
        const latDeg = parseFloat(dmsMatch[1]);
        const latMin = parseFloat(dmsMatch[2]);
        const latSec = parseFloat(dmsMatch[3] || "0");
        const latDir = dmsMatch[4].toUpperCase();
        
        const lonDeg = parseFloat(dmsMatch[5]);
        const lonMin = parseFloat(dmsMatch[6]);
        const lonSec = parseFloat(dmsMatch[7] || "0");
        const lonDir = dmsMatch[8].toUpperCase();
        
        let lat = latDeg + latMin / 60 + latSec / 3600;
        let lon = lonDeg + lonMin / 60 + lonSec / 3600;
        
        if (latDir === 'S') lat = -lat;
        if (lonDir === 'W') lon = -lon;
        
        if (!isNaN(lat) && !isNaN(lon) && 
            lat >= -90 && lat <= 90 && 
            lon >= -180 && lon <= 180) {
          return { lat, lon };
        }
      }
      
      return null;
    }
    
    // ===== PROCESSAMENTO DATI =====
    
    async function processDataInBatches(data, batchSize, progressCallback) {
      const total = data.length;
      const batches = Math.ceil(total / batchSize);
      const results = [];
      
      stats.totalCSV = total;
      updateProgress(0, total, 0);
      
      for (let i = 0; i < batches; i++) {
        const start = i * batchSize;
        const end = Math.min(start + batchSize, total);
        const batch = data.slice(start, end);
        
        // Processa batch
        for (const item of batch) {
          // Cerca coordinate
          const coordText = (
            item["grid_description"] || 
            item["description"] || 
            item["title"] || 
            item["grid_title"] || 
            ""
          ).trim();
          
          if (!coordText) continue;
          
          const cleanText = decodeHtmlEntities(coordText).replace(/\s+/g, ' ');
          const coords = extractCoordinates(cleanText);
          
          if (!coords) continue;
          
          // Filtra per Italia
          if (!isInItaly(coords.lat, coords.lon)) continue;
          
          // Estrai dati
          const title = (item["title"] || item["grid_title"] || "Luogo Abbandonato").trim();
          const desc = (item["grid_description"] || item["description"] || "").trim();
          const image = (
            item["story_pin_data/pages/0/blocks/0/image/images/originals/url"] ||
            item["image/url"] || 
            ""
          ).trim();
          
          results.push({
            lat: coords.lat,
            lon: coords.lon,
            title: title.substring(0, 80),
            description: desc.substring(0, 150),
            image: image || null
          });
          
          stats.totalItaly++;
        }
        
        // Aggiorna progresso
        updateProgress(end, total, Math.min(3, Math.floor((end / total) * 4)));
        
        // Piccola pausa per non bloccare l'UI
        await new Promise(resolve => setTimeout(resolve, 0));
      }
      
      return results;
    }
    
    // ===== INIZIALIZZAZIONE MAPPA =====
    
    function initializeMap() {
      // Crea mappa senza controlli zoom
      map = L.map('map', {
        zoomControl: false, // Rimuove i controlli +/-
        attributionControl: false,
        preferCanvas: true,
        maxZoom: 18,
        minZoom: 5
      }).setView(CONFIG.ITALY_CENTER, CONFIG.DEFAULT_ZOOM);
      
      // Aggiungi tile layer
      L.tileLayer(CONFIG.MAP_TILE_DARK, {
        attribution: CONFIG.MAP_TILE_ATTR,
        maxZoom: 19
      }).addTo(map);
      
      // Crea layer per marker
      markersLayer = L.layerGroup().addTo(map);
    }
    
    // Icona marker personalizzata (rossa con icona nera)
    function createCustomIcon() {
      return L.divIcon({
        className: 'custom-marker',
        html: `
          <div style="
            width: 32px;
            height: 32px;
            background: #d32f2f;
            border: 3px solid #121212;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.7);
            position: relative;
          ">
            <div style="
              color: #000000;
              font-size: 16px;
              font-weight: bold;
              transform: translateY(-1px);
            ">
              <i class="fas fa-map-pin"></i>
            </div>
            <div style="
              position: absolute;
              bottom: -5px;
              width: 0;
              height: 0;
              border-left: 6px solid transparent;
              border-right: 6px solid transparent;
              border-top: 8px solid #121212;
            "></div>
          </div>
        `,
        iconSize: [32, 40],
        iconAnchor: [16, 40],
        popupAnchor: [0, -35]
      });
    }
    
    function addMarkersToMap(locations) {
      if (!map || !markersLayer) return;
      
      // Cancella marker esistenti
      markersLayer.clearLayers();
      
      // Crea icona personalizzata
      const customIcon = createCustomIcon();
      
      // Crea tutti i marker
      allMarkers = locations.map(location => {
        const marker = L.marker([location.lat, location.lon], {
          icon: customIcon
        }).addTo(markersLayer);
        
        // Popup content (creato solo al click)
        marker.bindPopup(() => createPopupContent(location));
        
        // SOLO CLICK apre il popup (no hover)
        marker.off('mouseover');
        marker.off('mouseout');
        
        // Salva riferimento per performance
        marker.locationData = location;
        
        return marker;
      });
      
      // Aggiorna vista - FIX per errore getBounds
      if (allMarkers.length > 0) {
        // Crea bounds dai marker
        const bounds = L.latLngBounds(allMarkers.map(m => m.getLatLng()));
        
        if (bounds.isValid()) {
          // Piccolo delay per assicurarsi che la mappa sia renderizzata
          setTimeout(() => {
            map.fitBounds(bounds, { 
              padding: [50, 50],
              maxZoom: 10
            });
          }, 100);
        }
      }
    }
    
    function createPopupContent(location) {
      const coords = `${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}`;
      
      return `
        <div class="popup-header">
          <div class="popup-title">${escapeHtml(location.title)}</div>
          <div class="popup-coords">
            <i class="fas fa-map-marker-alt"></i>
            ${coords}
          </div>
        </div>
        <div class="popup-body">
          ${location.image ? `
            <img src="${location.image}" class="popup-image" 
                 alt="${escapeHtml(location.title)}"
                 loading="lazy"
                 onerror="this.style.display='none'">
          ` : ''}
          <div class="popup-description">
            ${escapeHtml(location.description || 'Nessuna descrizione disponibile')}
          </div>
          <div class="popup-actions">
            <button class="popup-btn copy" onclick="copyCoords(${location.lat}, ${location.lon}, this)">
              <i class="far fa-copy"></i> Copia
            </button>
            <button class="popup-btn maps" onclick="openMaps(${location.lat}, ${location.lon})">
              <i class="fab fa-google"></i> Mappe
            </button>
          </div>
        </div>
      `;
    }
    
    // ===== FUNZIONI INTERATTIVE =====
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function copyCoords(lat, lon, button) {
      const coords = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      navigator.clipboard.writeText(coords).then(() => {
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiato!';
        button.style.background = '#4CAF50';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      }).catch(() => {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = coords;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiato!';
        button.style.background = '#4CAF50';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      });
    }
    
    function openMaps(lat, lon) {
      const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      window.open(url, '_blank');
    }
    
    function hideLoader() {
      const loader = document.getElementById('loader');
      loader.style.opacity = '0';
      loader.style.transition = 'opacity 0.5s ease';
      
      setTimeout(() => {
        loader.classList.add('hidden');
      }, 500);
    }
    
    // ===== CARICAMENTO PRINCIPALE =====
    
    async function startMapLoading() {
      // Mostra il loader
      document.getElementById('loader').classList.remove('hidden');
      
      try {
        // 1. Inizializza mappa (vuota)
        initializeMap();
        updateProgress(10, 100, 0);
        
        // 2. Carica dati CSV
        const response = await fetch('spot.csv');
        if (!response.ok) throw new Error(`Errore caricamento dati: ${response.status}`);
        
        const csvText = await response.text();
        updateProgress(20, 100, 1);
        
        // 3. Converti CSV
        const csvData = csvToObjects(csvText);
        if (!csvData.length) throw new Error("Nessun dato trovato nel file");
        
        updateProgress(30, 100, 2);
        
        // 4. Processa dati (in batch per non bloccare UI)
        filteredLocations = await processDataInBatches(csvData, CONFIG.BATCH_SIZE, updateProgress);
        
        if (filteredLocations.length === 0) {
          throw new Error("Nessun luogo valido trovato in Italia");
        }
        
        updateProgress(95, 100, 3);
        
        // 5. Aggiungi TUTTI i marker in una volta
        addMarkersToMap(filteredLocations);
        
        // 6. Aggiorna statistiche finali
        updateProgress(100, 100, 4);
        
        // 7. Nascondi loader dopo breve delay
        setTimeout(hideLoader, 500);
        
      } catch (error) {
        console.error("Errore:", error);
        
        // Mostra errore nel loader
        document.getElementById('loaderStatus').textContent = `Errore: ${error.message}`;
        document.getElementById('progressBar').style.background = "#ff4444";
        
        // Inizializza comunque mappa vuota
        if (!map) initializeMap();
        
        // Nascondi loader dopo 3 secondi
        setTimeout(hideLoader, 3000);
      }
    }
    
    // ===== INIZIALIZZA APP =====
    
    document.addEventListener('DOMContentLoaded', initializeSocialUnlock);
    
    // Gestisci resize window
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (map) map.invalidateSize();
      }, 100);
    });
  </script>
</body>
</html>
