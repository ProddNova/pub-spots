<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Urbex Map LT-Unit</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    html, body, #map { 
      height: 100%; 
      width: 100%; 
      overflow: hidden;
    }
    
    /* Variabili tema rosso/nero */
    :root {
      --primary-red: #d32f2f;
      --primary-red-dark: #b71c1c;
      --primary-black: #121212;
      --secondary-black: #1e1e1e;
      --accent-red: #ff5252;
      --text-light: #ffffff;
      --text-gray: #b0b0b0;
      --card-bg: #1a1a1a;
      --border-color: #333333;
      --shadow-dark: rgba(0, 0, 0, 0.5);
    }
    
    body {
      background: var(--primary-black);
      color: var(--text-light);
    }
    
    /* Header branding - ROSSO e NERO */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      border-bottom: 2px solid var(--primary-red);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px var(--shadow-dark);
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo {
      width: 36px;
      height: 36px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #000000; /* ICONA NERA */
      font-weight: bold;
    }
    
    .brand-text h1 {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-red); /* TESTO ROSSO */
      line-height: 1.2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .brand-text p {
      font-size: 11px;
      color: var(--text-gray);
    }
    
    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      background: var(--secondary-black);
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .action-btn:hover {
      background: var(--primary-red);
      border-color: var(--primary-red);
    }
    
    /* Social unlock modal */
    .social-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary-black);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .social-modal.hidden {
      display: none;
    }
    
    .social-logo {
      width: 80px;
      height: 80px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }
    
    .social-logo i {
      font-size: 36px;
      color: #000000; /* Icona nera */
    }
    
    .social-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-red); /* Titolo rosso */
      margin-bottom: 10px;
      text-align: center;
    }
    
    .social-subtitle {
      color: var(--text-gray);
      text-align: center;
      max-width: 500px;
      line-height: 1.5;
      font-size: 16px;
      margin-bottom: 30px;
    }
    
    .social-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 30px;
    }
    
    .social-btn {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      background: var(--secondary-black);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    
    .social-btn.disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .social-btn.verifying {
      background: #2c3e50;
      pointer-events: none;
    }
    
    .social-btn.verifying.disabled {
      opacity: 1;
    }
    
    .social-btn.verified {
      background: #1a5d1a;
      border-color: #2ecc71;
    }
    
    .social-btn i {
      font-size: 24px;
      width: 30px;
      text-align: center;
    }
    
    .social-btn.youtube i {
      color: #FF0000;
    }
    
    .social-btn.instagram i {
      color: #E4405F;
    }
    
    .social-btn.tiktok i {
      color: #000000;
    }
    
    .social-btn .checkmark {
      position: absolute;
      right: 15px;
      color: #2ecc71;
      font-size: 18px;
      display: none;
    }
    
    .social-btn.verified .checkmark {
      display: block;
    }
    
    .verification-text {
      position: absolute;
      right: 15px;
      color: var(--primary-red);
      font-size: 12px;
      display: none;
      animation: blink 1.5s infinite;
    }
    
    .social-btn.verifying .verification-text {
      display: block;
    }
    
    .verification-info {
      font-size: 12px;
      color: var(--text-gray);
      text-align: center;
      margin-top: 5px;
      display: none;
    }
    
    .social-btn.verifying .verification-info {
      display: block;
    }
    
    .unlock-message {
      font-size: 14px;
      color: var(--text-gray);
      text-align: center;
      margin-top: 20px;
      min-height: 20px;
    }
    
    /* Warning modal */
    .warning-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary-black);
      z-index: 10001;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .warning-modal.active {
      display: flex;
    }
    
    .warning-content {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      border: 3px solid var(--primary-red);
      box-shadow: 0 10px 30px var(--shadow-dark);
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .warning-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-red);
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .warning-text {
      color: var(--text-light);
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .warning-text p {
      margin-bottom: 15px;
    }
    
    .warning-text ul {
      margin-left: 20px;
      margin-bottom: 20px;
    }
    
    .warning-text li {
      margin-bottom: 8px;
    }
    
    .warning-highlight {
      color: var(--primary-red);
      font-weight: 600;
      background: rgba(211, 47, 47, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .warning-accept-btn {
      background: var(--primary-red);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: block;
      margin: 30px auto 0;
      transition: all 0.3s;
      width: 100%;
      max-width: 300px;
    }
    
    .warning-accept-btn:hover {
      background: var(--primary-red-dark);
      transform: translateY(-2px);
    }
    
    /* Sidebar lista spot */
    .spots-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100%;
      background: var(--secondary-black);
      z-index: 1001;
      transition: right 0.3s ease;
      box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }
    
    .spots-sidebar.open {
      right: 0;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 2px solid var(--primary-red);
      background: var(--primary-black);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sidebar-header h3 i {
      color: var(--primary-red);
    }
    
    .close-sidebar-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 20px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
      transition: all 0.2s;
    }
    
    .close-sidebar-btn:hover {
      background: var(--primary-red);
    }
    
    .spots-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    
    .spot-card {
      background: var(--card-bg);
      border-radius: 10px;
      margin-bottom: 15px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .spot-card:hover {
      border-color: var(--primary-red);
      transform: translateY(-2px);
    }
    
    .spot-card.secret {
      border-color: #555;
      opacity: 0.8;
    }
    
    .spot-card.secret .spot-card-title {
      color: #999;
    }
    
    .spot-card.secret .spot-card-desc {
      color: #666;
    }
    
    .secret-badge {
      background: linear-gradient(135deg, #333, #555);
      color: #ccc;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid #666;
    }
    
    .spot-card-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      background: #222;
    }
    
    .spot-card-content {
      padding: 15px;
    }
    
    .spot-card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .spot-card-desc {
      font-size: 13px;
      color: var(--text-gray);
      margin-bottom: 12px;
      line-height: 1.4;
      max-height: 80px;
      overflow: hidden;
    }
    
    .spot-card-actions {
      display: flex;
      gap: 8px;
    }
    
    .spot-card-btn {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.2s;
    }
    
    .spot-card-btn.maps {
      background: var(--primary-red);
      color: white;
    }
    
    .spot-card-btn.maps:hover {
      background: var(--primary-red-dark);
    }
    
    .spot-card-btn.copy {
      background: var(--secondary-black);
      color: var(--text-light);
      border: 1px solid var(--border-color);
    }
    
    .spot-card-btn.copy:hover {
      background: #444;
    }
    
    /* Loader ottimizzato */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--primary-black);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .loader-overlay.hidden {
      display: none;
    }
    
    .loader-logo {
      width: 70px;
      height: 70px;
      background: var(--primary-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 25px;
    }
    
    .loader-logo i {
      font-size: 32px;
      color: #000000; /* Icona nera */
    }
    
    .loader-text {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary-red); /* Testo rosso */
      margin-bottom: 8px;
      text-align: center;
    }
    
    .loader-subtext {
      color: var(--text-gray);
      text-align: center;
      max-width: 280px;
      line-height: 1.4;
      font-size: 14px;
    }
    
    /* Popup style */
    .leaflet-popup-content-wrapper {
      background: var(--card-bg);
      color: var(--text-light);
      border-radius: 10px;
      border: 2px solid var(--primary-red);
      box-shadow: 0 8px 25px var(--shadow-dark);
      padding: 0;
      overflow: hidden;
      max-width: 320px;
    }
    
    .leaflet-popup-content {
      margin: 0;
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .leaflet-popup-tip {
      background: var(--primary-red);
    }
    
    .popup-header {
      padding: 15px;
      background: var(--primary-red);
      color: white;
    }
    
    .popup-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 5px;
      line-height: 1.2;
    }
    
    .popup-coords {
      font-size: 11px;
      opacity: 0.9;
      font-family: monospace;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .popup-body {
      padding: 15px;
    }
    
    .popup-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      background: #222;
    }
    
    .popup-description {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-gray);
      margin-bottom: 15px;
    }
    
    .popup-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .popup-btn {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .popup-btn.copy {
      background: var(--secondary-black);
      color: var(--text-light);
      border: 1px solid var(--border-color);
    }
    
    .popup-btn.copy:hover {
      background: #444;
    }
    
    .popup-btn.maps {
      background: var(--primary-red);
      color: white;
    }
    
    .popup-btn.maps:hover {
      background: var(--primary-red-dark);
    }
    
    /* Mobile optimization - IMPORTANTE */
    @media (max-width: 768px) {
      .header {
        padding: 8px 15px;
      }
      
      .brand-text h1 {
        font-size: 14px;
      }
      
      .brand-text p {
        display: none;
      }
      
      .action-buttons {
        gap: 8px;
      }
      
      .action-btn {
        padding: 8px; /* Più spazio per il tocco */
        font-size: 11px;
        min-width: 40px; /* Assicura dimensione minima */
        min-height: 40px;
        justify-content: center;
      }
      
      .action-btn span {
        display: none; /* Nascondi testo su mobile */
      }
      
      .action-btn i {
        font-size: 16px; /* Icone più grandi */
        margin: 0 !important;
      }
      
      .spots-sidebar {
        width: 100%;
        right: -100%;
      }
      
      .social-title {
        font-size: 22px;
      }
      
      .social-subtitle {
        font-size: 14px;
        padding: 0 15px;
      }
      
      .social-buttons {
        padding: 0 15px;
        gap: 12px;
      }
      
      .social-btn {
        padding: 12px 15px;
        font-size: 14px;
        gap: 12px;
      }
      
      /* Fix per testo verifica su mobile */
      .social-btn span {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .verification-text {
        position: absolute;
        right: 10px;
        font-size: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 2px 6px;
        border-radius: 4px;
        white-space: nowrap;
      }
      
      .verification-info {
        position: absolute;
        top: -20px;
        left: 0;
        right: 0;
        font-size: 10px;
        color: var(--primary-red);
        text-align: center;
      }
      
      .warning-content {
        padding: 20px;
        width: 95%;
      }
      
      .warning-title {
        font-size: 20px;
      }
      
      .leaflet-popup-content-wrapper {
        max-width: 280px;
      }
      
      .popup-header {
        padding: 12px;
      }
      
      .popup-body {
        padding: 12px;
      }
      
      /* Assicura che l'icona del bottone Italia sia visibile */
      .action-btn[onclick="zoomToItaly()"] i {
        display: block !important;
        color: white !important;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 8px 10px;
      }
      
      .social-title {
        font-size: 18px;
      }
      
      .social-buttons {
        width: 95%;
      }
      
      .warning-title {
        font-size: 18px;
      }
      
      .warning-text {
        font-size: 14px;
      }
    }
    
    /* Animazioni */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Stile per mappa senza zoom control */
    .leaflet-control-zoom {
      display: none !important;
    }
    
    .leaflet-control-attribution {
      display: none !important;
    }
    
    /* Simple marker style - ottimizzato per performance */
    .simple-marker {
      background: var(--primary-red);
      border: 3px solid var(--primary-black);
      border-radius: 50%;
      width: 20px !important;
      height: 20px !important;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
      transform: translate(-10px, -10px);
      cursor: pointer;
    }
    
    .simple-marker::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #000000;
      border-radius: 50%;
    }
    
    /* Evita scroll nei popup su mobile */
    .leaflet-popup-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .leaflet-popup-content::-webkit-scrollbar-track {
      background: var(--secondary-black);
    }
    
    .leaflet-popup-content::-webkit-scrollbar-thumb {
      background: var(--primary-red);
      border-radius: 3px;
    }
    
    /* Overlay per sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
    }
    
    .sidebar-overlay.active {
      display: block;
    }
    
    /* Loader per lista */
    .list-loader {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1002;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid var(--primary-red);
    }
    
    .list-loader.active {
      display: block;
    }
    
    /* Stile per desktop */
    @media (min-width: 769px) {
      .action-btn span {
        display: inline;
      }
    }
  </style>
</head>
<body>
  <!-- Social Unlock Modal -->
  <div class="social-modal" id="socialModal">
    <div class="social-logo">
      <i class="fas fa-lock"></i>
    </div>
    <div class="social-title">Urbex Map LT-Unit</div>
    <div class="social-subtitle">
      Per sbloccare l'accesso alla mappa, segui tutti i nostri social!
    </div>
    
    <div class="social-buttons">
      <a href="https://www.youtube.com/@LostTrace-Unit" target="_blank" class="social-btn youtube" id="youtubeBtn">
        <i class="fab fa-youtube"></i>
        <span>YouTube @LostTrace-Unit</span>
        <div class="checkmark"><i class="fas fa-check"></i></div>
        <div class="verification-text">Verifica in corso...</div>
        <div class="verification-info">Attendi 20 secondi dopo aver seguito</div>
      </a>
      
      <a href="https://www.instagram.com/losttrace__/" target="_blank" class="social-btn instagram disabled" id="instagramBtn">
        <i class="fab fa-instagram"></i>
        <span>Instagram @losttrace__</span>
        <div class="checkmark"><i class="fas fa-check"></i></div>
        <div class="verification-text">Verifica in corso...</div>
        <div class="verification-info">Attendi 20 secondi dopo aver seguito</div>
      </a>
      
      <a href="https://www.tiktok.com/@lt_unit" target="_blank" class="social-btn tiktok disabled" id="tiktokBtn">
        <i class="fab fa-tiktok"></i>
        <span>TikTok @lt_unit</span>
        <div class="checkmark"><i class="fas fa-check"></i></div>
        <div class="verification-text">Verifica in corso...</div>
        <div class="verification-info">Attendi 20 secondi dopo aver seguito</div>
      </a>
    </div>
    
    <div class="unlock-message" id="unlockMessage">
      Clicca su ogni social, segui il canale e attendi 20 secondi per la verifica automatica!
    </div>
  </div>
  
  <!-- Warning Modal -->
  <div class="warning-modal" id="warningModal">
    <div class="warning-content">
      <div class="warning-title">
        <i class="fas fa-exclamation-triangle"></i>
        AVVERTENZA IMPORTANTE
      </div>
      <div class="warning-text">
        <p>Questa mappa mostra luoghi abbandonati in Italia. Tieni presente che:</p>
        <ul>
          <li><span class="warning-highlight">NON siamo responsabili</span> per eventuali danni o conseguenze derivanti dalla visita di questi luoghi.</li>
          <li>Non incitiamo a visitare questi luoghi e <span class="warning-highlight">non ci assumiamo responsabilità</span> per eventuali incidenti.</li>
          <li>Alcuni luoghi potrebbero non essere più abbandonati, essere stati demoliti, essere pericolosi o proprietà privata.</li>
          <li>Questa mappa è <span class="warning-highlight">molto limitata</span> - la nostra vera mappa contiene molti più spot ma <span class="warning-highlight">non verrà mai resa pubblica</span> per prevenire vandalismi.</li>
          <li>Gli spot presenti sono stati raccolti da <span class="warning-highlight">informazioni pubbliche</span> e potrebbero essere incompleti o imprecisi.</li>
          <li>La nostra mappa reale rimarrà sempre <span class="warning-highlight">privata e accessibile solo ai membri del team</span> per proteggere i luoghi.</li>
        </ul>
        <p>Procedendo, dichiari di aver compreso e accettato questi termini.</p>
      </div>
      <button class="warning-accept-btn" onclick="acceptWarning()">
        <i class="fas fa-check"></i> Accetto e procedi alla mappa
      </button>
    </div>
  </div>
  
  <!-- Sidebar overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- Sidebar lista spot -->
  <div class="spots-sidebar" id="spotsSidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-list"></i> Lista Luoghi (<span id="spotsCount">0</span>)</h3>
      <button class="close-sidebar-btn" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="spots-list" id="spotsList">
      <!-- Gli spot verranno inseriti qui dinamicamente -->
    </div>
  </div>
  
  <!-- Loader per lista -->
  <div class="list-loader" id="listLoader">
    <div class="loader-logo" style="width: 50px; height: 50px; margin-bottom: 15px;">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <div class="loader-text" style="font-size: 16px;">Caricamento lista...</div>
  </div>
  
  <!-- Header -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="brand">
      <div class="logo">
        <i class="fas fa-skull-crossbones"></i>
      </div>
      <div class="brand-text">
        <h1>LT Unit Urbex Map</h1>
        <p>Mappa luoghi abbandonati</p>
      </div>
    </div>
    
    <div class="action-buttons">
      <button class="action-btn" onclick="zoomToItaly()" title="Centra la mappa sull'Italia">
        <i class="fas fa-italy"></i>
        <span>Italia</span>
      </button>
      <button class="action-btn" onclick="toggleSidebar()" title="Mostra lista luoghi">
        <i class="fas fa-list"></i>
        <span>Lista</span>
      </button>
    </div>
  </div>
  
  <!-- Mappa -->
  <div id="map" style="display: none;"></div>
  
  <!-- Loader -->
  <div class="loader-overlay hidden" id="loader">
    <div class="loader-logo">
      <i class="fas fa-map-marked-alt"></i>
    </div>
    <div class="loader-text">Caricamento Mappa</div>
    <div class="loader-subtext" id="loaderStatus">
      Inizializzazione sistema urbex...
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== CONFIGURAZIONI E VARIABILI GLOBALI =====
    const CONFIG = {
      MAP_TILE_DARK: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
      MAP_TILE_ATTR: '&copy; OpenStreetMap',
      ITALY_CENTER: [42.5, 12.5],
      DEFAULT_ZOOM: 6,
      
      // Bounding box Italia
      ITALY_BOUNDS: {
        minLat: 36.5,
        maxLat: 47.0,
        minLon: 6.5,
        maxLon: 18.5
      },
      
      // Social unlock settings - RIDOTTO A 20 SECONDI
      VERIFICATION_TIME: 20000, // 20 secondi
      
      // Performance settings
      BATCH_SIZE: 100,
      
      // Fake spots settings
      FAKE_SPOTS_COUNT: 650 // 600-700 spot finti
    };
    
    // Variabili globali
    let map = null;
    let markersLayer = null;
    let allMarkers = [];
    let filteredLocations = [];
    let allSpotsList = []; // Include reali + finti
    
    // Variabili social unlock
    let socialVerifications = {
      youtube: false,
      instagram: false,
      tiktok: false
    };
    
    let activeVerification = null;
    let verificationTimers = {
      youtube: null,
      instagram: null,
      tiktok: null
    };
    
    // ===== FUNZIONI PER GENERARE SPOT FINITI =====
    
    function generateFakeSpots(count) {
      const fakeSpots = [];
      const fakeTitles = [
        "Struttura Abbandonata", "Edificio Industriale Dismesso", "Villa in Degrado",
        "Fabbrica Chiusa", "Ospedale Fantasma", "Scuola Desertata",
        "Caserma Militare", "Centro Commerciale Vuoto", "Hotel in Disuso",
        "Stazione Ferroviaria", "Complesso Residenziale", "Centro Ricreativo",
        "Magazzino Industriale", "Impianto Sportivo", "Struttura Religiosa"
      ];
      
      const fakeDescriptions = [
        "Luogo abbandonato da diversi anni, condizioni precarie",
        "Struttura dismessa in attesa di riconversione",
        "Edificio storico in stato di degrado avanzato",
        "Complesso industriale chiuso negli anni '90",
        "Struttura militare abbandonata dopo la guerra fredda",
        "Ex centro sanitario chiuso per mancanza di fondi",
        "Impianto produttivo dismesso dopo la delocalizzazione"
      ];
      
      // Genera coordinate casuali in Italia
      for (let i = 0; i < count; i++) {
        const lat = CONFIG.ITALY_BOUNDS.minLat + 
                   Math.random() * (CONFIG.ITALY_BOUNDS.maxLat - CONFIG.ITALY_BOUNDS.minLat);
        const lon = CONFIG.ITALY_BOUNDS.minLon + 
                   Math.random() * (CONFIG.ITALY_BOUNDS.maxLon - CONFIG.ITALY_BOUNDS.minLon);
        
        const titleIndex = Math.floor(Math.random() * fakeTitles.length);
        const descIndex = Math.floor(Math.random() * fakeDescriptions.length);
        
        // Numero casuale per il nome
        const randomNum = Math.floor(Math.random() * 100) + 1;
        
        fakeSpots.push({
          lat: lat,
          lon: lon,
          title: `${fakeTitles[titleIndex]} #${randomNum}`,
          description: fakeDescriptions[descIndex],
          image: null,
          isFake: true // Flag per identificare spot finti
        });
      }
      
      return fakeSpots;
    }
    
    // ===== FUNZIONI SOCIAL UNLOCK =====
    
    function initializeSocialUnlock() {
      // Controlla se già sbloccato in precedenza
      const alreadyUnlocked = localStorage.getItem('urbexMapUnlocked') === 'true';
      
      if (alreadyUnlocked) {
        // Salta direttamente al caricamento
        document.getElementById('socialModal').classList.add('hidden');
        document.getElementById('mainHeader').style.display = 'flex';
        document.getElementById('map').style.display = 'block';
        startMapLoading();
      } else {
        // Mostra il modal di sblocco
        setupSocialButtons();
      }
    }
    
    function setupSocialButtons() {
      const youtubeBtn = document.getElementById('youtubeBtn');
      const instagramBtn = document.getElementById('instagramBtn');
      const tiktokBtn = document.getElementById('tiktokBtn');
      const unlockMessage = document.getElementById('unlockMessage');
      
      // Inizializza bottoni social
      updateSocialButtonsState();
      
      // Funzione per aggiornare lo stato dei bottoni
      function updateSocialButtonsState() {
        // Disabilita tutti i bottoni non ancora sbloccati se c'è una verifica in corso
        const anyVerifying = Object.values(verificationTimers).some(timer => timer !== null);
        
        if (anyVerifying) {
          // Disabilita i bottoni non verificati
          if (!socialVerifications.instagram) {
            instagramBtn.classList.add('disabled');
          }
          if (!socialVerifications.tiktok) {
            tiktokBtn.classList.add('disabled');
          }
        } else {
          // Riabilita i bottoni non verificati
          if (!socialVerifications.instagram) {
            instagramBtn.classList.remove('disabled');
          }
          if (!socialVerifications.tiktok) {
            tiktokBtn.classList.remove('disabled');
          }
        }
      }
      
      // Funzione per avviare la verifica di un social
      function startVerification(social, button) {
        if (activeVerification && activeVerification !== social) {
          unlockMessage.textContent = "Completa prima la verifica in corso!";
          return;
        }
        
        // Imposta la verifica attiva
        activeVerification = social;
        
        // Disabilita tutti gli altri bottoni
        updateSocialButtonsState();
        
        // Aggiungi classe verifying
        button.classList.add('verifying');
        
        // Mostra messaggio più chiaro
        unlockMessage.textContent = `Verifica ${social} in corso... Attendi 20 secondi dopo aver seguito!`;
        
        // Avvia il timer di verifica (20 secondi)
        verificationTimers[social] = setTimeout(() => {
          // Verifica completata
          button.classList.remove('verifying');
          button.classList.add('verified');
          socialVerifications[social] = true;
          activeVerification = null;
          verificationTimers[social] = null;
          
          // Riabilita i bottoni successivi
          updateSocialButtonsState();
          
          // Mostra messaggio di successo
          unlockMessage.textContent = `${social.charAt(0).toUpperCase() + social.slice(1)} verificato!`;
          
          // Controlla se tutti sono verificati
          checkAllSocials();
        }, CONFIG.VERIFICATION_TIME);
      }
      
      // Gestione click su YouTube
      youtubeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (socialVerifications.youtube) {
          // Già verificato, riapri solo il link
          window.open(this.href, '_blank');
          return;
        }
        
        if (verificationTimers.youtube) {
          // Verifica già in corso, riapri il link
          window.open(this.href, '_blank');
          return;
        }
        
        // Apri il link
        window.open(this.href, '_blank');
        
        // Avvia verifica
        startVerification('youtube', this);
      });
      
      // Gestione click su Instagram
      instagramBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (socialVerifications.instagram) {
          window.open(this.href, '_blank');
          return;
        }
        
        if (verificationTimers.instagram) {
          window.open(this.href, '_blank');
          return;
        }
        
        if (!socialVerifications.youtube) {
          unlockMessage.textContent = "Completa prima la verifica di YouTube!";
          return;
        }
        
        if (this.classList.contains('disabled')) {
          return;
        }
        
        window.open(this.href, '_blank');
        startVerification('instagram', this);
      });
      
      // Gestione click su TikTok
      tiktokBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (socialVerifications.tiktok) {
          window.open(this.href, '_blank');
          return;
        }
        
        if (verificationTimers.tiktok) {
          window.open(this.href, '_blank');
          return;
        }
        
        if (!socialVerifications.youtube || !socialVerifications.instagram) {
          unlockMessage.textContent = "Completa prima le verifiche di YouTube e Instagram!";
          return;
        }
        
        if (this.classList.contains('disabled')) {
          return;
        }
        
        window.open(this.href, '_blank');
        startVerification('tiktok', this);
      });
    }
    
    function checkAllSocials() {
      const allVerified = socialVerifications.youtube && socialVerifications.instagram && socialVerifications.tiktok;
      
      if (allVerified) {
        document.getElementById('unlockMessage').textContent = "Tutti i social verificati! Sblocco accesso...";
        
        // Piccolo delay prima di mostrare l'avvertenza
        setTimeout(() => {
          document.getElementById('socialModal').classList.add('hidden');
          document.getElementById('warningModal').classList.add('active');
        }, 1500);
      } else {
        const remaining = 3 - (socialVerifications.youtube + socialVerifications.instagram + socialVerifications.tiktok);
        document.getElementById('unlockMessage').textContent = `Completa ancora ${remaining} social! Ricorda: dopo aver seguito, attendi 20 secondi per la verifica automatica.`;
      }
    }
    
    function acceptWarning() {
      // Nascondi il modal di avvertenza
      document.getElementById('warningModal').classList.remove('active');
      
      // Salva lo sblocco in localStorage
      localStorage.setItem('urbexMapUnlocked', 'true');
      
      // Mostra header e mappa
      document.getElementById('mainHeader').style.display = 'flex';
      document.getElementById('map').style.display = 'block';
      
      // Inizia il caricamento della mappa
      startMapLoading();
    }
    
    // ===== FUNZIONI SIDEBAR =====
    
    async function toggleSidebar() {
      const sidebar = document.getElementById('spotsSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const listLoader = document.getElementById('listLoader');
      
      if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
      } else {
        // Mostra loader
        listLoader.classList.add('active');
        
        // Apri sidebar
        sidebar.classList.add('open');
        overlay.classList.add('active');
        
        // Popola la lista (con un piccolo delay per mostrare il loader)
        setTimeout(async () => {
          await populateSpotsList();
          listLoader.classList.remove('active');
        }, 50);
      }
    }
    
    async function populateSpotsList() {
      const spotsList = document.getElementById('spotsList');
      const spotsCount = document.getElementById('spotsCount');
      
      // Aggiorna contatore (reali + finti)
      spotsCount.textContent = allSpotsList.length;
      
      // Svuota la lista
      spotsList.innerHTML = '';
      
      // Mescola la lista per mischiare reali e finti
      const shuffledSpots = [...allSpotsList].sort(() => Math.random() - 0.5);
      
      // Aggiungi ogni spot alla lista
      shuffledSpots.forEach((location, index) => {
        const spotCard = document.createElement('div');
        spotCard.className = `spot-card ${location.isFake ? 'secret' : ''}`;
        
        if (!location.isFake) {
          spotCard.onclick = () => showOnMap(location.lat, location.lon, index);
        }
        
        const coords = location.isFake ? 'N/A' : `${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}`;
        
        spotCard.innerHTML = `
          ${location.image && !location.isFake ? `<img src="${location.image}" class="spot-card-image" alt="${escapeHtml(location.title)}" onerror="this.style.display='none'">` : ''}
          <div class="spot-card-content">
            <div class="spot-card-title">
              ${escapeHtml(location.title)}
              ${location.isFake ? '<span class="secret-badge">TOP SECRET</span>' : ''}
            </div>
            <div class="spot-card-desc">
              ${location.isFake 
                ? 'Accesso riservato. Questo spot è disponibile solo nella versione completa riservata ai membri del team.' 
                : escapeHtml(location.description || 'Nessuna descrizione disponibile')}
            </div>
            ${!location.isFake ? `
            <div class="spot-card-actions">
              <button class="spot-card-btn maps" onclick="event.stopPropagation(); openMaps(${location.lat}, ${location.lon})">
                <i class="fab fa-google"></i> Maps
              </button>
              <button class="spot-card-btn copy" onclick="event.stopPropagation(); copyCoords(${location.lat}, ${location.lon}, this)">
                <i class="far fa-copy"></i> Copia
              </button>
            </div>
            ` : ''}
          </div>
        `;
        
        spotsList.appendChild(spotCard);
      });
    }
    
    function showOnMap(lat, lon, index) {
      if (map) {
        // Chiudi sidebar
        toggleSidebar();
        
        // Centra la mappa sulla posizione
        map.setView([lat, lon], 14);
        
        // Trova il marker corrispondente (solo per spot reali)
        const markerIndex = allMarkers.findIndex(marker => 
          Math.abs(marker.getLatLng().lat - lat) < 0.001 && 
          Math.abs(marker.getLatLng().lng - lon) < 0.001
        );
        
        if (markerIndex !== -1) {
          const marker = allMarkers[markerIndex];
          const originalStyle = {
            fillColor: marker.options.fillColor,
            color: marker.options.color,
            weight: marker.options.weight
          };
          
          // Evidenzia il marker
          marker.setStyle({
            fillColor: '#ffeb3b',
            color: '#ffeb3b',
            weight: 4
          });
          
          // Ripristina lo stile originale dopo 2 secondi
          setTimeout(() => {
            marker.setStyle(originalStyle);
          }, 2000);
        }
      }
    }
    
    // ===== FUNZIONI DI UTILITY =====
    
    // Controlla se coordinate sono in Italia
    function isInItaly(lat, lon) {
      return lat >= CONFIG.ITALY_BOUNDS.minLat && 
             lat <= CONFIG.ITALY_BOUNDS.maxLat && 
             lon >= CONFIG.ITALY_BOUNDS.minLon && 
             lon <= CONFIG.ITALY_BOUNDS.maxLon;
    }
    
    // Decodifica HTML entities
    function decodeHtmlEntities(str) {
      if (!str) return "";
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }
    
    // Parsing CSV ottimizzato
    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let currentField = "";
      let inQuotes = false;
      
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        
        if (inQuotes) {
          if (char === '"' && text[i + 1] === '"') {
            currentField += '"';
            i++;
          } else if (char === '"') {
            inQuotes = false;
          } else {
            currentField += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            currentRow.push(currentField);
            currentField = "";
          } else if (char === '\r') {
            continue;
          } else if (char === '\n') {
            currentRow.push(currentField);
            rows.push(currentRow);
            currentRow = [];
            currentField = "";
          } else {
            currentField += char;
          }
        }
      }
      
      if (currentField || currentRow.length) {
        currentRow.push(currentField);
        rows.push(currentRow);
      }
      
      return rows.filter(row => row.some(field => field.trim()));
    }
    
    // Converti CSV in oggetti
    function csvToObjects(csvText) {
      try {
        const rows = parseCSV(csvText);
        if (rows.length < 2) return [];
        
        const headers = rows[0].map(h => h.trim());
        const result = [];
        
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const obj = {};
          
          for (let j = 0; j < headers.length; j++) {
            if (j < row.length) {
              obj[headers[j]] = row[j] || "";
            } else {
              obj[headers[j]] = "";
            }
          }
          
          result.push(obj);
        }
        
        return result;
      } catch (error) {
        console.error("Errore parsing CSV:", error);
        return [];
      }
    }
    
    // Estrazione coordinate ottimizzata
    function extractCoordinates(text) {
      if (!text) return null;
      
      // Cerca prima coordinate decimali (più comune)
      const decimalPattern = /([+-]?\d+\.\d+)\s*[,;]?\s*([+-]?\d+\.\d+)/;
      const decMatch = text.match(decimalPattern);
      
      if (decMatch) {
        const lat = parseFloat(decMatch[1]);
        const lon = parseFloat(decMatch[2]);
        
        if (!isNaN(lat) && !isNaN(lon) && 
            lat >= -90 && lat <= 90 && 
            lon >= -180 && lon <= 180) {
          return { lat, lon };
        }
      }
      
      // Fallback: cerca coordinate DMS
      const dmsPattern = /(\d+)[°º]\s*(\d+)[′']\s*([\d.]+)?[″"]?\s*([NS])\s+(\d+)[°º]\s*(\d+)[′']\s*([\d.]+)?[″"]?\s*([EW])/i;
      const dmsMatch = text.match(dmsPattern);
      
      if (dmsMatch) {
        const latDeg = parseFloat(dmsMatch[1]);
        const latMin = parseFloat(dmsMatch[2]);
        const latSec = parseFloat(dmsMatch[3] || "0");
        const latDir = dmsMatch[4].toUpperCase();
        
        const lonDeg = parseFloat(dmsMatch[5]);
        const lonMin = parseFloat(dmsMatch[6]);
        const lonSec = parseFloat(dmsMatch[7] || "0");
        const lonDir = dmsMatch[8].toUpperCase();
        
        let lat = latDeg + latMin / 60 + latSec / 3600;
        let lon = lonDeg + lonMin / 60 + lonSec / 3600;
        
        if (latDir === 'S') lat = -lat;
        if (lonDir === 'W') lon = -lon;
        
        if (!isNaN(lat) && !isNaN(lon) && 
            lat >= -90 && lat <= 90 && 
            lon >= -180 && lon <= 180) {
          return { lat, lon };
        }
      }
      
      return null;
    }
    
    // ===== PROCESSAMENTO DATI =====
    
    async function processDataInBatches(data, batchSize) {
      const total = data.length;
      const results = [];
      
      for (let i = 0; i < total; i += batchSize) {
        const batch = data.slice(i, i + batchSize);
        
        // Processa batch
        for (const item of batch) {
          // Cerca coordinate
          const coordText = (
            item["grid_description"] || 
            item["description"] || 
            item["title"] || 
            item["grid_title"] || 
            ""
          ).trim();
          
          if (!coordText) continue;
          
          const cleanText = decodeHtmlEntities(coordText).replace(/\s+/g, ' ');
          const coords = extractCoordinates(cleanText);
          
          if (!coords) continue;
          
          // Filtra per Italia
          if (!isInItaly(coords.lat, coords.lon)) continue;
          
          // Estrai dati
          const title = (item["title"] || item["grid_title"] || "Luogo Abbandonato").trim();
          const desc = (item["grid_description"] || item["description"] || "").trim();
          const image = (
            item["story_pin_data/pages/0/blocks/0/image/images/originals/url"] ||
            item["image/url"] || 
            ""
          ).trim();
          
          results.push({
            lat: coords.lat,
            lon: coords.lon,
            title: title.substring(0, 80),
            description: desc.substring(0, 150),
            image: image || null,
            isFake: false
          });
        }
        
        // Aggiorna loader
        const progress = Math.min(Math.round((i + batchSize) / total * 100), 100);
        document.getElementById('loaderStatus').textContent = `Caricamento luoghi... ${progress}%`;
        
        // Piccola pausa per non bloccare l'UI
        await new Promise(resolve => setTimeout(resolve, 0));
      }
      
      return results;
    }
    
    // ===== INIZIALIZZAZIONE MAPPA =====
    
    function initializeMap() {
      // Crea mappa senza controlli zoom
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false,
        preferCanvas: true,
        maxZoom: 18,
        minZoom: 5
      }).setView(CONFIG.ITALY_CENTER, CONFIG.DEFAULT_ZOOM);
      
      // Aggiungi tile layer
      L.tileLayer(CONFIG.MAP_TILE_DARK, {
        attribution: CONFIG.MAP_TILE_ATTR,
        maxZoom: 19
      }).addTo(map);
      
      // Crea layer per marker
      markersLayer = L.layerGroup().addTo(map);
    }
    
    function addMarkersToMap(locations) {
      if (!map || !markersLayer) return;
      
      // Cancella marker esistenti
      markersLayer.clearLayers();
      
      // Crea tutti i marker (pallini semplici per performance) - SOLO SPOT REALI
      allMarkers = locations.filter(loc => !loc.isFake).map(location => {
        // Crea marker semplice per performance
        const marker = L.circleMarker([location.lat, location.lon], {
          radius: 10,
          fillColor: "#d32f2f",
          fillOpacity: 0.9,
          color: "#121212",
          weight: 3,
          opacity: 1,
          className: 'simple-marker'
        }).addTo(markersLayer);
        
        // Popup content (creato solo al click)
        marker.bindPopup(() => createPopupContent(location));
        
        // SOLO CLICK apre il popup (no hover)
        marker.off('mouseover');
        marker.off('mouseout');
        
        // Salva riferimento per performance
        marker.locationData = location;
        
        return marker;
      });
      
      // Aggiorna vista - FIX per errore getBounds
      if (allMarkers.length > 0) {
        // Crea bounds dai marker
        const bounds = L.latLngBounds(allMarkers.map(m => m.getLatLng()));
        
        if (bounds.isValid()) {
          // Piccolo delay per assicurarsi che la mappa sia renderizzata
          setTimeout(() => {
            map.fitBounds(bounds, { 
              padding: [50, 50],
              maxZoom: 10
            });
          }, 100);
        }
      }
    }
    
    function createPopupContent(location) {
      const coords = `${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}`;
      
      return `
        <div class="popup-header">
          <div class="popup-title">${escapeHtml(location.title)}</div>
          <div class="popup-coords">
            <i class="fas fa-map-marker-alt"></i>
            ${coords}
          </div>
        </div>
        <div class="popup-body">
          ${location.image ? `
            <img src="${location.image}" class="popup-image" 
                 alt="${escapeHtml(location.title)}"
                 loading="lazy"
                 onerror="this.style.display='none'">
          ` : ''}
          <div class="popup-description">
            ${escapeHtml(location.description || 'Nessuna descrizione disponibile')}
          </div>
          <div class="popup-actions">
            <button class="popup-btn copy" onclick="copyCoords(${location.lat}, ${location.lon}, this)">
              <i class="far fa-copy"></i> Copia
            </button>
            <button class="popup-btn maps" onclick="openMaps(${location.lat}, ${location.lon})">
              <i class="fab fa-google"></i> Mappe
            </button>
          </div>
        </div>
      `;
    }
    
    // ===== FUNZIONI INTERATTIVE =====
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function copyCoords(lat, lon, button) {
      const coords = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      navigator.clipboard.writeText(coords).then(() => {
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiato!';
        button.style.background = '#4CAF50';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      }).catch(() => {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = coords;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copiato!';
        button.style.background = '#4CAF50';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      });
    }
    
    function openMaps(lat, lon) {
      const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      window.open(url, '_blank');
    }
    
    function zoomToItaly() {
      if (map) {
        map.setView(CONFIG.ITALY_CENTER, CONFIG.DEFAULT_ZOOM);
      }
    }
    
    function hideLoader() {
      const loader = document.getElementById('loader');
      loader.style.opacity = '0';
      loader.style.transition = 'opacity 0.5s ease';
      
      setTimeout(() => {
        loader.classList.add('hidden');
      }, 500);
    }
    
    // ===== CARICAMENTO PRINCIPALE =====
    
    async function startMapLoading() {
      // Mostra il loader
      document.getElementById('loader').classList.remove('hidden');
      
      try {
        // 1. Inizializza mappa (vuota)
        initializeMap();
        document.getElementById('loaderStatus').textContent = "Inizializzazione mappa...";
        
        // 2. Carica dati CSV
        const response = await fetch('spot.csv');
        if (!response.ok) throw new Error(`Errore caricamento dati: ${response.status}`);
        
        const csvText = await response.text();
        document.getElementById('loaderStatus').textContent = "Analisi dati CSV...";
        
        // 3. Converti CSV
        const csvData = csvToObjects(csvText);
        if (!csvData.length) throw new Error("Nessun dato trovato nel file");
        
        document.getElementById('loaderStatus').textContent = "Filtro per Italia...";
        
        // 4. Processa dati (in batch per non bloccare UI)
        filteredLocations = await processDataInBatches(csvData, CONFIG.BATCH_SIZE);
        
        if (filteredLocations.length === 0) {
          throw new Error("Nessun luogo valido trovato in Italia");
        }
        
        // 5. Genera spot finti per la lista
        document.getElementById('loaderStatus').textContent = "Generazione contenuti esclusivi...";
        const fakeSpots = generateFakeSpots(CONFIG.FAKE_SPOTS_COUNT);
        
        // 6. Combina spot reali e finti per la lista
        allSpotsList = [...filteredLocations, ...fakeSpots];
        
        document.getElementById('loaderStatus').textContent = "Creazione mappa...";
        
        // 7. Aggiungi TUTTI i marker in una volta (solo spot reali)
        addMarkersToMap(filteredLocations);
        
        document.getElementById('loaderStatus').textContent = "Mappa pronta!";
        
        // 8. Nascondi loader dopo breve delay
        setTimeout(hideLoader, 500);
        
      } catch (error) {
        console.error("Errore:", error);
        
        // Mostra errore nel loader
        document.getElementById('loaderStatus').textContent = `Errore: ${error.message}`;
        
        // Inizializza comunque mappa vuota
        if (!map) initializeMap();
        
        // Nascondi loader dopo 3 secondi
        setTimeout(hideLoader, 3000);
      }
    }
    
    // ===== INIZIALIZZA APP =====
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeSocialUnlock();
      
      // Chiudi sidebar quando si clicca sull'overlay
      document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
    });
    
    // Gestisci resize window
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (map) map.invalidateSize();
      }, 100);
    });
  </script>
</body>
</html>