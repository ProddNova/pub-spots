<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mappa Luoghi Abbandonati</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; }
    html, body, #map { height: 100%; width: 100%; }
    .leaflet-popup-content {
      max-height: 500px;
      overflow-y: auto;
      max-width: 320px;
      padding: 10px;
    }
    .open-gmaps-btn {
      background: #4285F4; color: white; border: none; padding: 10px;
      border-radius: 5px; margin-top: 10px; cursor: pointer;
      font-size: 14px; width: 100%; font-weight: bold;
    }
    .copy-coords-btn {
      background: #34A853; color: white; border: none; padding: 8px;
      border-radius: 5px; margin-top: 8px; cursor: pointer;
      font-size: 13px; width: 100%;
    }
    .location-info {
      font-size: 12px; color: #666; margin-top: 5px; padding: 5px;
      background: #f5f5f5; border-radius: 3px;
    }
    .popup-title { font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #333; }
    .popup-desc { font-size: 14px; margin-bottom: 10px; color: #444; }
    .info-legend {
      position: absolute; bottom: 20px; left: 20px; z-index: 1000;
      background: white; padding: 10px; border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2); font-size: 12px;
    }
    /* Dark mode styles */
    body.dark-mode {
      background: #1e1e1e;
      color: #ddd;
    }
    body.dark-mode .leaflet-popup-content {
      background: #2c2c2c;
      color: #ddd;
    }
    body.dark-mode .open-gmaps-btn {
      background: #3367d6;
    }
    body.dark-mode .copy-coords-btn {
      background: #2e7d32;
    }
    body.dark-mode .location-info {
      color: #bbb;
      background: #333;
    }
    body.dark-mode .popup-title {
      color: #eee;
    }
    body.dark-mode .popup-desc {
      color: #ccc;
    }
    body.dark-mode .info-legend {
      background: #2c2c2c;
      color: #ddd;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    /* Dark mode toggle button */
    .dark-mode-toggle {
      position: absolute; top: 20px; right: 20px; z-index: 1000;
      background: white; padding: 10px; border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: pointer;
      font-size: 14px; font-weight: bold;
    }
    body.dark-mode .dark-mode-toggle {
      background: #2c2c2c;
      color: #ddd;
    }
    /* Loading indicator */
    #loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 1001; background: rgba(255,255,255,0.8); padding: 20px;
      border-radius: 10px; font-size: 16px; display: none;
    }
    body.dark-mode #loading {
      background: rgba(0,0,0,0.8); color: #ddd;
    }
    /* Recenter button */
    .recenter-btn {
      position: absolute; bottom: 20px; right: 20px; z-index: 1000;
      background: white; padding: 10px; border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2); cursor: pointer;
      font-size: 14px; font-weight: bold;
    }
    body.dark-mode .recenter-btn {
      background: #2c2c2c;
      color: #ddd;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">Caricamento dati...</div>
  <div class="dark-mode-toggle" onclick="toggleDarkMode()">üåô Dark Mode</div>
  <div class="recenter-btn" onclick="recenterMap()">üîÑ Ricentra Mappa</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const LIGHT_TILE_SERVER = "https://tile.openstreetmap.org/{z}/{x}/{y}.png";
    const DARK_TILE_SERVER = "https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png";
    const DEFAULT_MAP_CENTER = [45.0, 10.0];
    const DEFAULT_ZOOM = 6;
    const ITALY_BOUNDS = { minLat: 36.6, maxLat: 47.1, minLon: 6.6, maxLon: 18.5 };
    let locations = [];
    let map;
    let tileLayer;
    let markers = [];
    let isDarkMode = false;
    let mapBounds;
    // ---------- Utils: HTML entities decode ----------
    function decodeHtmlEntities(str) {
      if (!str) return "";
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }
    // ---------- Utils: CSV parsing (robusto) ----------
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ',') {
            row.push(field);
            field = "";
          } else if (c === '\r') {
          } else if (c === '\n') {
            row.push(field);
            field = "";
            rows.push(row);
            row = [];
          } else {
            field += c;
          }
        }
      }
      row.push(field);
      rows.push(row);
      while (rows.length && rows[rows.length - 1].every(v => (v ?? "").trim() === "")) {
        rows.pop();
      }
      return rows;
    }
    function csvToObjects(csvText) {
      const rows = parseCSV(csvText);
      if (!rows.length) return [];
      const headers = rows[0].map(h => (h ?? "").trim());
      const objs = [];
      for (let r = 1; r < rows.length; r++) {
        const line = rows[r];
        if (!line || line.every(v => (v ?? "").trim() === "")) continue;
        const obj = {};
        for (let c = 0; c < headers.length; c++) {
          const key = headers[c];
          if (!key) continue;
          obj[key] = line[c] ?? "";
        }
        objs.push(obj);
      }
      return objs;
    }
    // ---------- Estrazione coordinate ----------
    function extractCoordinates(text) {
      if (!text) return null;
      const dmsPattern =
        /([0-9.]+)\s*¬∞\s*([0-9.]+)\s*['‚Ä≤]?\s*([0-9.]+(?:\.[0-9]+)?)?\s*["‚Ä≥]?\s*([NSns])\s+([0-9.]+)\s*¬∞\s*([0-9.]+)\s*['‚Ä≤]?\s*([0-9.]+(?:\.[0-9]+)?)?\s*["‚Ä≥]?\s*([EWew])/i;
      const match = text.match(dmsPattern);
      if (match) {
        let latDeg = parseFloat(match[1]);
        let latMin = parseFloat(match[2]);
        let latSec = parseFloat(match[3] || '0');
        let latDir = match[4].toUpperCase();
        let lonDeg = parseFloat(match[5]);
        let lonMin = parseFloat(match[6]);
        let lonSec = parseFloat(match[7] || '0');
        let lonDir = match[8].toUpperCase();
        let lat = latDeg + latMin / 60 + latSec / 3600;
        let lon = lonDeg + lonMin / 60 + lonSec / 3600;
        if (latDir === 'S') lat = -lat;
        if (lonDir === 'W') lon = -lon;
        if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
          return { lat: parseFloat(lat.toFixed(8)), lon: parseFloat(lon.toFixed(8)) };
        }
      }
      const decimalPattern = /([+-]?\d+\.\d+)\s*[,;]?\s*([+-]?\d+\.\d+)/;
      const decMatch = text.match(decimalPattern);
      if (decMatch) {
        let lat = parseFloat(decMatch[1]);
        let lon = parseFloat(decMatch[2]);
        if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
          return { lat, lon };
        }
      }
      return null;
    }
    // ---------- Carica e processa spot.csv ----------
    async function loadAndProcessData() {
      document.getElementById('loading').style.display = 'block';
      try {
        const response = await fetch('spot.csv');
        if (!response.ok) throw new Error(`Impossibile caricare spot.csv (HTTP ${response.status})`);
        const csvText = await response.text();
        const data = csvToObjects(csvText);
        if (!Array.isArray(data)) {
          throw new Error("Il CSV non √® stato convertito correttamente in un array.");
        }
        let total = data.length;
        let skipped = 0;
        for (const pin of data) {
          let coordText =
            (pin["grid_description"] || pin["description"] || pin["title"] || pin["grid_title"] || "").trim();
          if (!coordText) {
            skipped++;
            continue;
          }
          coordText = decodeHtmlEntities(coordText);
          coordText = coordText.replace(/\s+/g, ' ').trim();
          const coordMatch = extractCoordinates(coordText);
          if (!coordMatch) {
            skipped++;
            continue;
          }
          // Filtra solo punti in Italia
          const { lat, lon } = coordMatch;
          if (lat < ITALY_BOUNDS.minLat || lat > ITALY_BOUNDS.maxLat ||
              lon < ITALY_BOUNDS.minLon || lon > ITALY_BOUNDS.maxLon) {
            skipped++;
            continue;
          }
          const title = (pin["title"] || pin["grid_title"] || "Luogo sconosciuto").trim();
          const descriptionRaw =
            (pin["grid_description"] || pin["description"] || pin["title"] || coordText || "").trim();
          const description = decodeHtmlEntities(descriptionRaw).replace(/\s+/g, ' ').trim();
          let imageUrl =
            (pin["story_pin_data/pages/0/blocks/0/image/images/originals/url"] || "").trim();
          if (!imageUrl) {
            imageUrl = (pin["image/url"] || "").trim();
          }
          if (!imageUrl) {
            imageUrl = (pin["board/image_thumbnail_url"] || "").trim();
          }
          locations.push({
            latitude: lat,
            longitude: lon,
            title: title,
            description: description,
            image: imageUrl || null
          });
        }
        console.log("Punti validi trovati:", locations.length);
        console.log("Skipped:", skipped);
        if (locations.length === 0) {
          alert(`Nessun punto valido trovato su ${total} totali. Tutti skipped. Verifica il formato delle coordinate in grid_description/description.`);
          return;
        }
        initMap();
      } catch (error) {
        console.error("Errore:", error);
        alert("Errore nel caricamento o elaborazione di spot.csv: " + error.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    // ---------- Mappa ----------
    function initMap() {
      map = L.map('map');
      tileLayer = L.tileLayer(LIGHT_TILE_SERVER, {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      // Icona nera custom
      const blackIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      locations.forEach(loc => {
        const marker = L.marker([loc.latitude, loc.longitude], { icon: blackIcon }).addTo(map);
        markers.push(marker);
        const coords = loc.latitude.toFixed(6) + ',' + loc.longitude.toFixed(6);
        const popupContent = `
          <div>
            ${loc.image ? `
              <img src="${loc.image}" alt="${escapeHtml(loc.title)}"
                   style="width:100%; height:auto; max-height:400px; object-fit:contain; border-radius:8px; margin-bottom:10px;"
                   onerror="this.style.display='none'" />
            ` : ''}
            <div class="popup-title">${escapeHtml(loc.title)}</div>
            <div class="popup-desc">${escapeHtml(loc.description || 'Nessuna descrizione')}</div>
            <div class="location-info">
              <strong>Coordinate:</strong><br>
              ${coords}
            </div>
            <button class="copy-coords-btn" onclick="copyToClipboard('${coords}')">
              üìã Copia coordinate
            </button>
            <button class="open-gmaps-btn" onclick="openGoogleMaps(${loc.latitude}, ${loc.longitude})">
              üó∫Ô∏è Apri in Google Maps
            </button>
          </div>
        `;
        marker.bindPopup(popupContent);
      });
      if (locations.length > 0) {
        mapBounds = L.latLngBounds(markers.map(m => m.getLatLng()));
        if (locations.length === 1) {
          map.setView([locations[0].latitude, locations[0].longitude], 13);
        } else {
          map.fitBounds(mapBounds, { padding: [50, 50] });
        }
      } else {
        map.setView(DEFAULT_MAP_CENTER, DEFAULT_ZOOM);
      }
      L.control.scale().addTo(map);
      const legend = document.createElement('div');
      legend.className = 'info-legend';
      legend.innerHTML = `<strong>${locations.length}</strong> luoghi caricati (marker singoli)`;
      document.body.appendChild(legend);
    }
    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      const toggleBtn = document.querySelector('.dark-mode-toggle');
      toggleBtn.textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
      // Cambia tile layer
      map.removeLayer(tileLayer);
      const tileUrl = isDarkMode ? DARK_TILE_SERVER : LIGHT_TILE_SERVER;
      const attribution = isDarkMode ? '&copy; <a href="https://carto.com/attributions">CARTO</a> & <a href="https://www.openstreetmap.org/copyright">OSM</a>' : '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
      tileLayer = L.tileLayer(tileUrl, { attribution }).addTo(map);
    }
    function recenterMap() {
      if (mapBounds) {
        map.fitBounds(mapBounds, { padding: [50, 50] });
      } else {
        map.setView(DEFAULT_MAP_CENTER, DEFAULT_ZOOM);
      }
    }
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Coordinate copiate: ' + text);
      }).catch(() => {
        alert('Coordinate (copia manuale): ' + text);
      });
    }
    function openGoogleMaps(lat, lon) {
      const url = 'https://www.google.com/maps/search/?api=1&query=' + lat + ',' + lon;
      if (confirm('Vuoi aprire questa posizione in Google Maps?')) {
        window.open(url, '_blank');
      }
    }
    // Avvia
    loadAndProcessData();
  </script>
</body>
</html>
